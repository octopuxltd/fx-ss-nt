<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Tab</title>
    <link rel="stylesheet" href="suggestions.css">
    <style>
        /* Override hover for ut.html - only show selection state, not hover */
        .ut-page .search-suggestions-preview-item:hover:not(.is-selected),
        .ut-page .search-suggestions-preview-item:focus-within:not(.is-selected) {
            background-color: transparent;
        }
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            background-image: url('bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .pane {
            padding: 24px;
        }

        .search-container {
            flex: 1;
            overflow-y: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: var(--search-wrapper-offset, 240px);
            padding-bottom: 80px;
        }

        .top-overlay.is-focused .search-container {
            overflow-y: auto;
        }

        .top-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0);
            padding: 16px 24px;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0);
            height: 130px;
            box-sizing: border-box;
            overflow: hidden;
            transition: background-color 0.6s ease, border-bottom-color 0.6s ease, height 0.6s ease, border-bottom-left-radius 0.6s ease, border-bottom-right-radius 0.6s ease;
            display: flex;
            flex-direction: column;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .top-overlay.is-scrolled {
            background-color: rgba(255, 255, 255, 0.95);
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        .top-overlay.is-focused {
            height: 85vh;
            background-color: rgba(255, 255, 255, 0.85);
            border-bottom-color: rgba(0, 0, 0, 0.05);
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
            overflow-y: auto;
        }

        .top-overlay.no-transition {
            transition: none !important;
        }

        .top-overlay.no-transition .search-wrapper,
        .top-overlay.no-transition .search-description,
        .top-overlay.no-transition .search-suggestions-preview {
            transition: none !important;
        }

        .firefox-logo {
            position: fixed;
            top: 32px;
            left: 34px;
            width: 48px;
            height: 48px;
            z-index: 11;
        }

        .close-button {
            position: fixed;
            top: 32px;
            right: 34px;
            width: 48px;
            height: 48px;
            z-index: 11;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .top-overlay.is-focused .close-button {
            opacity: 0.5;
            pointer-events: auto;
        }

        .close-button:hover {
            opacity: 1 !important;
        }

        .close-button svg {
            width: 48px;
            height: 48px;
            stroke: #1F2933;
            stroke-width: 1;
            transition: stroke 0.2s ease, stroke-width 0.2s ease;
        }

        .close-button:hover svg {
            stroke: #000000;
            stroke-width: 1.5;
        }

        .vpn-indicator {
            position: fixed;
            top: 32px;
            right: 34px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 11;
            font-size: 14px;
            font-weight: 600;
            color: #1F2933;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .vpn-indicator.is-active {
            display: flex;
        }

        .top-overlay.is-focused .vpn-indicator {
            top: 88px;
        }

        .vpn-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            flex-shrink: 0;
        }

        .demo-searches {
            position: fixed;
            top: 170px;
            left: 34px;
            font-size: 13px;
            color: #FFFFFF;
            line-height: 1.6;
            pointer-events: auto;
            transition: color 0.3s ease;
            z-index: 11;
            width: 150px;
        }

        .top-overlay.is-focused .demo-searches {
            color: #6B7280;
        }

        .demo-searches-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .demo-searches ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .demo-searches li {
            margin: 2px 0;
        }

        .demo-searches .not-implemented {
            text-decoration: line-through;
        }

        .info-icon-wrapper {
            position: fixed;
            bottom: 24px;
            left: 34px;
            z-index: 11;
        }

        .info-icon-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .info-icon-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .info-icon-button svg {
            width: 18px;
            height: 18px;
            stroke: #374151;
        }

        .demo-searches-card {
            position: absolute;
            bottom: 40px;
            left: 0;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 12;
        }

        .info-icon-wrapper.is-open .demo-searches-card {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .demo-searches-earlier {
            font-size: 13px;
            color: #1F2933;
            line-height: 1.6;
        }

        .top-overlay.is-focused .demo-searches-earlier {
            color: #1F2933;
        }

        .demo-searches-earlier .demo-searches-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .demo-searches-earlier ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .demo-searches-earlier li {
            margin: 2px 0;
        }

        .search-wrapper {
            position: fixed;
            top: 32px;
            left: 50%;
            transform: translateX(-50%);
            width: 56%;
            margin: 0;
            transition: width 0.35s ease-in-out;
            border: 1px solid transparent;
            border-radius: 28px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 12px 12px rgba(15, 23, 42, 0.12);
        }

        .search-wrapper::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 28px;
            padding: 2px;
            background: conic-gradient(from 0deg, #945AF2 0%, #F37E49 71%, #945AF2 100%);
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.35s ease-in-out;
        }

        .search-wrapper:focus-within::before {
            opacity: 1;
        }

        .search-wrapper.expanded {
            width: 70%;
        }

        .search-wrapper:focus-within {
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.99);
        }

        .top-overlay.is-scrolled .search-wrapper,
        .top-overlay.is-focused .search-wrapper {
            border-color: rgba(15, 23, 42, 0.12);
        }

        .search-input-shell {
            position: relative;
            padding: 18px 18px 5px; padding-right: 50px;
            padding-left: 84px;
        }

        .search-input-shell {
            padding-right: 50px;
        }

        .search-clear-button {
            position: absolute;
            right: 18px;
            top: calc(50% + 7px);
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: opacity 0.2s ease;
            z-index: 1;
        }

        .search-clear-button:hover {
            opacity: 1;
        }

        .search-clear-button svg {
            width: 16px;
            height: 16px;
            stroke: #1F2933;
        }

        .search-dropdown-button {
            position: absolute;
            left: 7px;
            top: calc(50% + 7px);
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            padding: 9px 10px;
            border-radius: 999px;
            background-color: #FFFFFF;
        }

        .circle-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: 6px;
            border-radius: 50%;
            background-color: #FFFFFF;
        }

        .circle-icon__image {
            width: 16px;
            height: 16px;
        }

        .chevron {
            width: 12px;
            height: 12px;
            margin-left: 6px;
            position: relative;
            top: 1px;
        }

        .search-box {
            width: 100%;
            padding: 0;
            border: none;
            background: transparent;
            font-size: 16px;
            color: #000000;
        }

        .search-box::placeholder {
            color: #000000;
        }

        .top-overlay.is-focused .search-box::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .search-box:focus {
            outline: none;
        }

        .search-description {
            width: 100%;
            margin: 0 auto;
            padding: 0 0 32px;
        }

        .top-overlay.is-focused .search-description {
            width: 100%;
        }

        .overlay-product-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
            width: 70%;
            max-width: 1200px;
            margin: 0 auto;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .top-overlay.is-focused .overlay-product-grid {
            opacity: 1;
        }

        .overlay-product-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .overlay-product-heading {
            margin: 0;
            font-size: 12px;
            font-weight: 400;
            letter-spacing: normal;
            color: #6B7280;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .top-overlay.is-focused .overlay-product-heading {
            opacity: 1;
        }

        .overlay-product-card {
            background: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
            text-decoration: none;
            color: inherit;
            height: 90px;
            transition: background-color 0.2s ease, opacity 0.6s ease;
            opacity: 0;
        }

        .top-overlay.is-focused .overlay-product-card {
            opacity: 1;
        }

        .overlay-product-card img:not(.overlay-product-favicon):not(.overlay-product-meta-favicon) {
            width: 90px;
            height: 90px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .overlay-product-card--article img {
            width: 100% !important;
            height: 160px !important;
            object-fit: cover;
        }

        .overlay-product-card-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            justify-content: center;
        }

        .overlay-product-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: #1F2933;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .overlay-product-meta {
            font-size: 12px;
            margin: 0;
            color: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overlay-product-meta-favicon {
            width: 16px !important;
            height: 16px !important;
            flex-shrink: 0;
            object-fit: contain;
            max-width: 16px !important;
            max-height: 16px !important;
        }

        .overlay-product-card:hover,
        .overlay-product-card:focus {
            background-color: #F3F4F6;
        }

        .overlay-product-card--article {
            flex-direction: column;
            height: 290px;
        }

        .overlay-product-card--article .overlay-product-card-body {
            padding: 16px;
            flex-grow: 1;
        }

        .overlay-product-card--article .overlay-product-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .overlay-product-card--article .overlay-product-meta {
            font-size: 12px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overlay-product-card--article .overlay-product-meta-favicon {
            width: 16px !important;
            height: 16px !important;
            flex-shrink: 0;
            object-fit: contain;
            max-width: 16px !important;
            max-height: 16px !important;
        }

        .overlay-product-card--article:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .overlay-product-card--article:hover .overlay-product-title {
            color: #1E90FF;
        }

        .overlay-product-card--article:hover,
        .overlay-product-card--article:focus {
            background-color: #FFFFFF;
        }





        .pane--bottom {
            min-height: 100vh;
            background: transparent;
            color: #4a3419;
            overflow-y: auto;
            padding: 0;
            position: relative;
        }

        .bottom-overlay {
            position: fixed;
            top: 130px;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0);
            pointer-events: none;
            z-index: 5;
            margin-top: -50px;
            transition: top 0.6s ease, background-color 0.6s ease;
        }

        .bottom-overlay.no-transition {
            transition: none !important;
        }

        .bottom-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
            padding: 24px;
            padding-top: calc(130px + 24px);
        }

        .quick-tiles {
            width: 70%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .quick-tiles__tile {
            flex: 0 0 120px;
            height: 120px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-tiles__favicon {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .heading {
            font-size: 16px;
            font-weight: bold;
            text-align: left;
            margin: 0;
            padding-top: 16px;
            width: 70%;
            max-width: 1200px;
            color: #FFFFFF;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 26px;
            width: 70%;
            max-width: 1200px;
            transition: opacity 0.6s ease;
            opacity: 1;
        }

        .top-overlay.is-focused ~ .bottom-content .articles-grid {
            opacity: 0.5;
        }

        .card {
            background-color: #FFFFFF;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 275px;
            transition: box-shadow 0.15s ease-in-out;
        }

        .card h2 {
            margin: 16px;
            font-size: 18px;
            text-align: left;
            color: #333;
            font-weight: 500;
            flex-grow: 1;
        }

        .card p {
            margin-left: 16px;
            margin-bottom: 16px;
            font-size: 12px;
            text-align: left;
            color: #777;
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .card:hover h2 {
            color: #1E90FF;
        }

        a.card {
            text-decoration: none;
            color: inherit;
            display: block;
            height: 100%;
        }

        .image-placeholder {
            width: 100%;
            height: 160px;
            background-color: #CCC;
        }

        p {
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .no-transition {
            transition: none !important;
        }

        .search-background-bottom-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 54px;
            border: none;
            background-color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-overlay.is-focused .search-background-bottom-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .search-background-bottom-overlay svg {
            display: block;
        }

        .search-background-bottom-overlay .chevron-shallow {
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }

        .search-background-bottom-overlay .chevron-steep {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .search-background-bottom-overlay:hover {
            background-color: rgba(255, 255, 255, 1);
            opacity: 1;
        }

        .search-background-bottom-overlay:hover .chevron-shallow {
            opacity: 0;
        }

        .search-background-bottom-overlay:hover .chevron-steep {
            opacity: 1;
            stroke: #374151;
        }

        .debug-buttons {
            position: fixed;
            top: 32px;
            right: 24px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .top-overlay.is-focused .debug-buttons {
            opacity: 1;
            pointer-events: auto;
        }

        .debug-buttons-bottom {
            position: absolute;
            bottom: 62px;
            right: 24px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .top-overlay.is-focused .debug-buttons-bottom {
            opacity: 1;
            pointer-events: auto;
        }

        .debug-button {
            width: auto;
            height: auto;
            padding: 4px 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #374151;
            font-size: 8px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            white-space: nowrap;
            text-align: left;
        }

        .debug-button:hover {
            background-color: rgba(229, 231, 235, 0.95);
            border-color: rgba(0, 0, 0, 0.2);
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .phase-toggle {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .phase-toggle__link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(15, 23, 42, 0.4);
            color: #FFFFFF;
            font-size: 11px;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .phase-toggle-heading {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            width: 100%;
        }

        .phase-toggle__link:hover,
        .phase-toggle__link:focus {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.7);
            outline: none;
        }

        .phase-toggle__link.is-active {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(255, 255, 255, 0.9);
        }

        .phase-toggle__label {
            display: none;
        }

        .phase-toggle__link.is-active .phase-toggle__label {
            display: inline;
        }

        .phase-toggle__number {
            margin-left: 0;
        }

        .phase-toggle__link.is-active .phase-toggle__number {
            margin-left: 4px;
        }

        .local-carrot-row {
            display: none;
            width: 100%;
            padding: 0 8px;
            margin-top: 12px;
        }

        .local-carrot-row.is-visible {
            display: flex;
        }

        .local-carrot-grid {
            display: flex;
            gap: 12px;
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .local-carrot-grid .search-suggestions-preview-item {
            flex: 1 1 0;
        }

        .search-suggestions-preview-column-container.local-horizontal .search-suggestions-preview-list:first-child {
            flex: 0 0 100%;
        }

        .search-suggestions-preview-column-container.local-horizontal .search-suggestions-preview-list:last-child {
            display: none;
        }
    </style>
    <script src="product-sections/product-history.js"></script>
    <script src="product-sections/product-bookmarks.js"></script>
    <script src="product-sections/product-open-tabs.js"></script>
    <script src="product-sections/product-articles.js"></script>
    <script src="product-content.js"></script>
    <script src="carrot-templates.js"></script>
    <script src="suggestion-words.js"></script>
    <script src="image-preload.js"></script>
    <script>
        // OpenRouter API Configuration
        const OPENROUTER_API_KEY = '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'; // Set your API key here
        const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        
        // Debounce timer for API calls
        let apiCallTimer = null;
        let lastApiQuery = '';
        
        // Track which suggestions are from AI (for icon assignment)
        let aiSuggestionsSet = new Set();
        
        // LocalStorage cache functions
        function getCacheKey(query) {
            return `ai_suggestions_${query.toLowerCase().trim()}`;
        }
        
        function getCachedSuggestions(query) {
            try {
                const cacheKey = getCacheKey(query);
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    // Check if cache is still valid (24 hours)
                    const cacheAge = Date.now() - parsed.timestamp;
                    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                    if (cacheAge < maxAge) {
                        console.log('[API] Found cached suggestions:', parsed.suggestions);
                        // Filter cached suggestions to only include word-start matches
                        const queryLower = query.toLowerCase();
                        const filtered = parsed.suggestions.filter(suggestion => {
                            const suggestionLower = suggestion.toLowerCase();
                            // Check if suggestion starts with query
                            if (suggestionLower.startsWith(queryLower)) {
                                return true;
                            }
                            // Check if any word in the suggestion starts with the query
                            const words = suggestionLower.split(/\s+/);
                            return words.some(word => word.startsWith(queryLower));
                        });
                        return filtered.length > 0 ? filtered : null;
                    } else {
                        console.log('[API] Cache expired, removing old cache');
                        localStorage.removeItem(cacheKey);
                    }
                }
            } catch (error) {
                console.error('[API] Error reading from cache:', error);
            }
            return null;
        }
        
        function cacheSuggestions(query, suggestions) {
            try {
                const cacheKey = getCacheKey(query);
                const cacheData = {
                    suggestions: suggestions,
                    timestamp: Date.now()
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                console.log('[API] Cached suggestions for:', query);
            } catch (error) {
                console.error('[API] Error caching suggestions:', error);
                // localStorage might be full, try to clear old entries
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('ai_suggestions_')) {
                            keysToRemove.push(key);
                        }
                    }
                    // Remove oldest 10 entries if cache is full
                    if (keysToRemove.length > 50) {
                        keysToRemove.slice(0, 10).forEach(key => localStorage.removeItem(key));
                        // Retry caching
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                    }
                } catch (e) {
                    console.error('[API] Could not clear cache:', e);
                }
            }
        }
        
        async function fetchAISuggestions(query) {
            console.log('[API] Starting fetchAISuggestions for query:', query);
            
            // Check cache first
            const cached = getCachedSuggestions(query);
            if (cached && cached.length > 0) {
                console.log('[API] Returning cached suggestions');
                return cached;
            }
            
            if (!OPENROUTER_API_KEY) {
                console.warn('[API] OpenRouter API key not set');
                return [];
            }
            
            const requestBody = {
                // Common OpenRouter models: 'anthropic/claude-3-haiku', 'google/gemini-pro', 'meta-llama/llama-3.1-8b-instruct'
                model: 'anthropic/claude-3-haiku', // Fast, lightweight model
                messages: [
                    {
                        role: 'system',
                        content: 'You are a search suggestion generator. Generate 10 popular search queries where at least one word starts with the user\'s query characters. For example, if the user types "abc", return suggestions like "abc news", "abc store", "abc company" where words start with "abc". The query characters need not form a complete word - they are the beginning of words. Return ONLY a JSON array of strings, sorted by popularity (most popular first). No explanations, just the array.'
                    },
                    {
                        role: 'user',
                        content: `Generate 10 popular search suggestions where at least one word starts with: "${query}"`
                    }
                ],
                temperature: 0.7,
                max_tokens: 200
            };
            
            console.log('[API] Request URL:', OPENROUTER_API_URL);
            console.log('[API] Request body:', JSON.stringify(requestBody, null, 2));
            
            try {
                const startTime = Date.now();
                console.log('[API] Making fetch request...');
                
                const response = await fetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Search Suggestions'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const requestDuration = Date.now() - startTime;
                console.log('[API] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    duration: `${requestDuration}ms`,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    let errorText;
                    try {
                        errorText = await response.text();
                        console.error('[API] Response not OK:', {
                            status: response.status,
                            statusText: response.statusText,
                            body: errorText
                        });
                        // Try to parse as JSON for better error message
                        try {
                            const errorJson = JSON.parse(errorText);
                            console.error('[API] Error JSON:', errorJson);
                        } catch (e) {
                            // Not JSON, that's fine
                        }
                    } catch (e) {
                        errorText = 'Could not read error response';
                        console.error('[API] Could not read error response:', e);
                    }
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('[API] Response data:', JSON.stringify(data, null, 2));
                
                const content = data.choices[0]?.message?.content?.trim();
                console.log('[API] Extracted content:', content);
                
                if (!content) {
                    console.warn('[API] No content in response');
                    return [];
                }
                
                // Parse JSON array from response
                let suggestions = [];
                try {
                    // Try to parse as JSON array
                    const jsonMatch = content.match(/\[.*\]/s);
                    if (jsonMatch) {
                        console.log('[API] Found JSON array match:', jsonMatch[0]);
                        suggestions = JSON.parse(jsonMatch[0]);
                        console.log('[API] Parsed suggestions:', suggestions);
                    } else {
                        console.log('[API] No JSON array found, trying line-by-line parsing');
                        // Fallback: split by lines and clean up
                        suggestions = content.split('\n')
                            .map(line => line.trim().replace(/^[-•\d.\s"']+|[-•\d.\s"']+$/g, ''))
                            .filter(line => line.length > 0)
                            .slice(0, 10);
                        console.log('[API] Line-parsed suggestions:', suggestions);
                    }
                } catch (parseError) {
                    console.error('[API] Error parsing AI response:', parseError);
                    console.error('[API] Content that failed to parse:', content);
                    // Fallback: extract quoted strings
                    const quotedMatches = content.match(/"([^"]+)"/g);
                    if (quotedMatches) {
                        suggestions = quotedMatches.map(m => m.replace(/"/g, '')).slice(0, 10);
                        console.log('[API] Fallback quoted-string suggestions:', suggestions);
                    }
                }
                
                const finalSuggestions = suggestions.filter(s => s && s.length > 0).slice(0, 10);
                console.log('[API] Final suggestions to return:', finalSuggestions);
                console.log('[API] Total duration:', `${Date.now() - startTime}ms`);
                
                // Cache the suggestions for future use
                if (finalSuggestions.length > 0) {
                    cacheSuggestions(query, finalSuggestions);
                }
                
                return finalSuggestions;
            } catch (error) {
                console.error('[API] Error fetching AI suggestions:', error);
                console.error('[API] Error stack:', error.stack);
                return [];
            }
        }
    </script>
    <script>
        // Set phase number for image preloader
        window.currentPhase = 5;
        if (typeof preloadCarrotImages === 'function') {
            preloadCarrotImages(5);
        }
    </script>
</head>
<body class="ut-page">
    <section class="pane pane--bottom">
        <div class="bottom-overlay" aria-hidden="true"></div>
        <div class="top-overlay">
            <img src="icons/Fx-Browser-icon-fullColor-64.png" alt="Firefox" class="firefox-logo">
            <button class="close-button" type="button" aria-label="Close search panel">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="vpn-indicator" id="vpn-indicator">
                <span class="vpn-indicator-dot"></span>
                <span>VPN</span>
            </div>
            <div class="info-icon-wrapper">
                <button class="info-icon-button" type="button" aria-label="Show demo searches">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="12" cy="8" r="1" fill="currentColor"/>
                    </svg>
                </button>
                <div class="demo-searches-card">
                    <div class="demo-searches-earlier">
                        <ul>
                            <li>• fox wiki</li>
                            <li>• chair</li>
                            <li>• sneakers</li>
                            <li>• uber stock</li>
                            <li>• AC8170</li>
                            <li>• lakers game</li>
                            <li>• coffee shops</li>
                            <li>• weather</li>
                            <li>• vpn</li>
                            <li>• MDN</li>
                            <li>• youtube</li>
                            <li>• time tokyo</li>
                            <li>• happy emoji</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- DEBUG BUTTONS - DO NOT DELETE! Uncomment for testing/development -->
            <!--
            <div class="debug-buttons">
                <button class="debug-button" type="button">1. No enriched content</button>
                <button class="debug-button" type="button">2. Local recommendations</button>
                <button class="debug-button" type="button">3. Flights (AC 8170)</button>
                <button class="debug-button" type="button">4. Wikipedia</button>
                <button class="debug-button" type="button">5. Weather</button>
                <button class="debug-button" type="button">6. Sports</button>
                <button class="debug-button" type="button">7. Stocks</button>
                <button class="debug-button" type="button">8. World clock</button>
                </div>
            <div class="debug-buttons-bottom">
                <button class="debug-button" type="button">A</button>
                <button class="debug-button" type="button">B</button>
                <button class="debug-button" type="button">C</button>
                <button class="debug-button" type="button">D</button>
                <button class="debug-button" type="button">E</button>
                </div>
            -->
            <button class="search-background-bottom-overlay" type="button">
                <span class="visually-hidden">Collapse search overlay</span>
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path class="chevron-shallow" d="M4 20L16 15L28 20" stroke="#6B7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path class="chevron-steep" d="M6 20L16 12L26 20" stroke="#6B7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="search-container">
                <div class="search-wrapper">
                    <div class="search-input-shell">
                        <div class="search-dropdown-button">
                            <span class="circle-icon">
                                <img src="icons/Google.svg" alt="Search options" class="circle-icon__image">
                            </span>
                            <img src="icons/chevron.svg" alt="Expand" class="chevron">
            </div>
                        <input type="text" class="search-box" placeholder="Search or start browsing">
                        <button type="button" class="search-clear-button" aria-label="Clear search" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                </div>
                    <div class="search-suggestions-preview" aria-hidden="true">
                        <div class="search-suggestions-divider"></div>
                        <div class="local-carrot-row" aria-hidden="true"></div>
                        <div class="search-suggestions-preview-column-container expand-left">
                        <ul class="search-suggestions-preview-list">
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">hoka</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">macbook</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">13 in macbook air</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">Coffee machines for sale</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">taylor swift</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">coffee grinder</span>
                            </li>
                            <li class="search-suggestions-preview-item">
                                <img src="icons/clock.svg" alt="" aria-hidden="true" class="suggestion-icon">
                                <span class="label">gmail</span>
                            </li>
                        </ul>
                            <ul class="search-suggestions-preview-list">
                                <li class="search-suggestions-preview-item carrot">
                                    <div class="carrot-tile" aria-hidden="true"></div>
                                    <div class="carrot-lines">
                                        <p class="carrot-line">Departure <strong>9:21pm</strong> Chicago (CHI)</p>
                                        <p class="carrot-line">Arrival <strong>11:42am</strong> Vancouver (VYR)</p>
                                        <p class="carrot-line carrot-line--meta"><span class="carrot-line green-text">In flight</span> · Today · AC 8170</p>
            </div>
                                </li>
                                <li class="search-suggestions-preview-item carrot">
                                    <div class="carrot-tile" aria-hidden="true"></div>
                                    <div class="carrot-lines">
                                        <p class="carrot-line">Departure <strong>7:05am</strong> New York (JFK)</p>
                                        <p class="carrot-line">Arrival <strong>9:18am</strong> Toronto (YYZ)</p>
                                        <p class="carrot-line carrot-line--meta">Boarding · Thu, June 5 · DL 4732</p>
        </div>
                                </li>
                                <li class="search-suggestions-preview-item carrot">
                                    <div class="carrot-tile" aria-hidden="true"></div>
                                    <div class="carrot-lines">
                                        <p class="carrot-line">Departure <strong>2:45pm</strong> Los Angeles (LAX)</p>
                                        <p class="carrot-line">Arrival <strong>6:10pm</strong> Seattle (SEA)</p>
                                        <p class="carrot-line carrot-line--meta">Scheduled · Fri, June 6 · AS 124</p>
                        </div>
                                </li>
                            </ul>
                    </div>
                </div>
                </div>
                <div class="search-description">
                    <div class="overlay-product-grid" data-product-grid data-product-sections="history,openTabs,bookmarks,articles"></div>
                </div>
            </div>
        </div>
        <div class="bottom-content">
                <div class="quick-tiles" aria-hidden="true">
                    <span class="quick-tiles__tile"><img src="favicons/Google.svg" alt="" class="quick-tiles__favicon"></span>
                    <span class="quick-tiles__tile"><img src="favicons/YouTube.svg" alt="" class="quick-tiles__favicon"></span>
                    <span class="quick-tiles__tile"><img src="favicons/Instagram.svg" alt="" class="quick-tiles__favicon"></span>
                    <span class="quick-tiles__tile"><img src="favicons/Reddit.svg" alt="" class="quick-tiles__favicon"></span>
                    <span class="quick-tiles__tile"><img src="favicons/Twitter.svg" alt="" class="quick-tiles__favicon"></span>
                    <span class="quick-tiles__tile"><img src="favicons/Wikipedia.svg" alt="" class="quick-tiles__favicon"></span>
                </div>
                <h1 class="heading">Thought-provoking stories</h1>
                <div class="articles-grid">
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Surprising Science Behind Lightning</h2>
                    <p>SELF G</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Ten People Go on Trial in Paris</h2>
                    <p>The Guardian</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Can Dogs Sense Ghosts?</h2>
                    <p>Popular Science</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>11 One-Pot Gut-Healthy Dinners</h2>
                    <p>Eating Well</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Dark Side of Mirrors in Space</h2>
                    <p>Nautilus</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>UK Regional Airline Suspends Ops</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Internet Is Going to Break Again</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The 1 Surprising Snack People Eat</h2>
                    <p>Eating Well</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Reclaiming 72 Hours a Week</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Hidden Dangers in Fast Food</h2>
                    <p>Health Digest</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Exploring Virtual Reality</h2>
                    <p>Tech Today</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Unveiling the Quantum Age</h2>
                    <p>Scientific Insights</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Breakthroughs in Renewable Energy</h2>
                    <p>Eco World</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Astronomy's New Frontiers</h2>
                    <p>Space Observer</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Innovative Designs in Architecture</h2>
                    <p>Modern Home</p>
                </a>
            </div>
        </div>
    </section>
    <script>
        const apiKey = 'bCm88s2aE42pgTVWHJn6CRvAf916qPGquNowlZue6tSbVSImQ0hdsWSX';
        const keywords = [
            'UTI', 'trial Paris', 'ghosts',
            'healthy dinner', 'mirrors space', 'UK airline',
            'internet', 'snack', 'productivity',
            'fast food', 'virtual reality', 'quantum physics',
            'renewable energy', 'astronomy', 'architecture'
        ];

        const renderOverlayProductGrid = () => {
            const container = document.querySelector('[data-product-grid]');
            if (!container || typeof productContent?.renderInto !== 'function') {
                return;
            }

            const sectionAttr = container.getAttribute('data-product-sections');
            const sectionKeys = sectionAttr ? sectionAttr.split(',').map((section) => section.trim()).filter(Boolean) : undefined;

            productContent.renderInto(container, sectionKeys);
        };

        const fetchImages = async () => {
            const imageUrls = [];

            for (const keyword of keywords) {
                try {
                    const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(keyword)}&per_page=1`, {
                    headers: {
                        Authorization: apiKey
                    }
                });

                    if (!response.ok) {
                        throw new Error(`Pexels request failed: ${response.status}`);
                    }

                const data = await response.json();
                    const photoUrl = data.photos && data.photos[0] ? data.photos[0].src.medium : null;
                    imageUrls.push(photoUrl || 'https://via.placeholder.com/600x400?text=Image');
                } catch (error) {
                    console.error('Error fetching image for keyword:', keyword, error);
                    imageUrls.push('https://via.placeholder.com/600x400?text=Image');
            }
            }

            return imageUrls;
        };

        const updateImages = async () => {
            const imagePlaceholders = document.querySelectorAll('.image-placeholder');
            if (!imagePlaceholders.length) {
                return;
            }

            const images = await fetchImages();

            imagePlaceholders.forEach((placeholder, index) => {
                const img = document.createElement('img');
                img.src = images[index] || 'https://via.placeholder.com/600x400?text=Image';
                img.alt = placeholder.nextElementSibling ? placeholder.nextElementSibling.textContent : 'Article image';
                img.style.width = '100%';
                img.style.height = '160px';
                img.style.objectFit = 'cover';
                placeholder.replaceWith(img);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderOverlayProductGrid();
            updateImages();
            // Attach hover listeners to initial suggestions
            attachHoverListeners();
        });

        const topOverlay = document.querySelector('.top-overlay');
        const bottomOverlay = document.querySelector('.bottom-overlay');
        const searchWrapperElement = document.querySelector('.search-wrapper');
        const searchDescriptionElement = document.querySelector('.search-description');
        const searchSuggestionsPreviewElement = document.querySelector('.search-suggestions-preview');
        const searchBoxElement = document.querySelector('.search-box');
        const searchClearButton = document.querySelector('.search-clear-button');
        const searchContainer = document.querySelector('.search-container');
        const productContainers = Array.from(document.querySelectorAll('.search-wrapper-products, .search-description'));
        const resizeObservers = [];

        const updateSearchContentOffset = () => {
            if (!searchWrapperElement || !searchContainer) {
                return;
            }

            const wrapperRect = searchWrapperElement.getBoundingClientRect();
            const containerRect = searchContainer.getBoundingClientRect();
            const spacing = 32;
            const offset = Math.max(wrapperRect.bottom - containerRect.top + spacing, spacing);

            searchContainer.style.setProperty('--search-wrapper-offset', `${offset}px`);
        };

        if (searchWrapperElement && searchContainer) {
            updateSearchContentOffset();

            if (typeof ResizeObserver === 'function') {
                const wrapperObserver = new ResizeObserver(updateSearchContentOffset);
                wrapperObserver.observe(searchWrapperElement);
                resizeObservers.push(wrapperObserver);

                productContainers.forEach((container) => {
                    if (container) {
                        const containerObserver = new ResizeObserver(updateSearchContentOffset);
                        containerObserver.observe(container);
                        resizeObservers.push(containerObserver);
                    }
                });
            }

            window.addEventListener('resize', updateSearchContentOffset);
        }

        const localCarrotRow = document.querySelector('.local-carrot-row');
        const showAdMarketplaceCarrots = () => {
            if (!localCarrotRow) {
                return;
            }

            localCarrotRow.innerHTML = `<ul class="local-carrot-grid">${carrotTemplates.adMarketplace()}</ul>`;
            localCarrotRow.classList.add('is-visible');
            localCarrotRow.setAttribute('aria-hidden', 'false');

            if (suggestionsContainer) {
                suggestionsContainer.classList.add('local-horizontal');
                suggestionsContainer.classList.remove('show-carrot');
                suggestionsContainer.classList.remove('expand-left');
            }

            if (carrotList) {
                carrotList.innerHTML = '';
                carrotList.dataset.carrotState = '0';
            }
        };

        const hideLocalCarrots = () => {
            if (!localCarrotRow) {
                return;
            }

            localCarrotRow.innerHTML = '';
            localCarrotRow.classList.remove('is-visible');
            localCarrotRow.setAttribute('aria-hidden', 'true');

            if (suggestionsContainer) {
                suggestionsContainer.classList.remove('local-horizontal');
                if (!carrotList || !carrotList.innerHTML.trim()) {
                    suggestionsContainer.classList.remove('show-carrot');
                }
            }
        };

        if (document.readyState !== 'loading') {
            if (searchBoxElement) {
                searchBoxElement.value = '';
            }
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                if (searchBoxElement) {
                    searchBoxElement.value = '';
                }
            });
        }
 
         const OVERLAY_STATE_KEY = 'overlayExpanded';
         const OVERLAY_RESTORE_KEY = 'overlayRestorePending';
 
         const elementsForTransitionControl = [topOverlay, bottomOverlay, searchWrapperElement, searchDescriptionElement, searchSuggestionsPreviewElement];

        const setOverlayState = (expanded, { suppressTransition = false } = {}) => {
            if (!topOverlay || !bottomOverlay || !searchWrapperElement || !searchDescriptionElement || !searchSuggestionsPreviewElement) {
                return;
            }

            if (suppressTransition) {
                elementsForTransitionControl.forEach((el) => el && el.classList.add('no-transition'));
            }

            if (expanded) {
                topOverlay.classList.add('is-focused');
                searchWrapperElement.classList.add('expanded');
                searchDescriptionElement.classList.add('expanded');
                bottomOverlay.style.top = '85vh';
                bottomOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                bottomOverlay.style.pointerEvents = 'auto';
            } else {
                topOverlay.classList.remove('is-focused');
                searchWrapperElement.classList.remove('expanded');
                searchDescriptionElement.classList.remove('expanded');
                bottomOverlay.style.top = '130px';
                bottomOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0)';
                bottomOverlay.style.pointerEvents = 'none';
            }

            sessionStorage.setItem(OVERLAY_STATE_KEY, expanded ? 'true' : 'false');

        if (typeof requestAnimationFrame === 'function') {
            requestAnimationFrame(() => updateSearchContentOffset());
        } else {
            updateSearchContentOffset();
        }

            if (suppressTransition) {
                requestAnimationFrame(() => {
                    elementsForTransitionControl.forEach((el) => el && el.classList.remove('no-transition'));
                });
            }
        };

        if (topOverlay && bottomOverlay) {
            const handleOverlayBackground = () => {
                const scrolled = window.scrollY > 0;
                topOverlay.classList.toggle('is-scrolled', scrolled);
            };
            handleOverlayBackground();
            window.addEventListener('scroll', handleOverlayBackground, { passive: true });
        }

        // Animate gradient border
        const searchWrapper = document.querySelector('.search-wrapper');
        let gradientAnimationId = null;
        let gradientAngle = 0;

        const animateGradient = () => {
            if (searchWrapper && searchBoxElement && document.activeElement === searchBoxElement) {
                gradientAngle = (gradientAngle + 1.2) % 360;
                const beforeElement = window.getComputedStyle(searchWrapper, '::before');
                searchWrapper.style.setProperty('--gradient-angle', `${gradientAngle}deg`);
                // Directly update the background of the pseudo-element
                const style = document.createElement('style');
                style.id = 'gradient-animation-style';
                const existingStyle = document.getElementById('gradient-animation-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                style.textContent = `.search-wrapper:focus-within::before { background: conic-gradient(from ${gradientAngle}deg, #945AF2 0%, #F37E49 71%, #945AF2 100%); }`;
                document.head.appendChild(style);
                gradientAnimationId = requestAnimationFrame(animateGradient);
            } else {
                const existingStyle = document.getElementById('gradient-animation-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                if (gradientAnimationId) {
                    cancelAnimationFrame(gradientAnimationId);
                    gradientAnimationId = null;
                }
            }
        };

        if (topOverlay && searchBoxElement && bottomOverlay) {
            searchBoxElement.addEventListener('focus', () => {
                setOverlayState(true);
                setTimeout(() => {
                    if (!gradientAnimationId) {
                        animateGradient();
                    }
                }, 50);
            });

            searchBoxElement.addEventListener('blur', () => {
                const existingStyle = document.getElementById('gradient-animation-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                if (gradientAnimationId) {
                    cancelAnimationFrame(gradientAnimationId);
                    gradientAnimationId = null;
                }
            });
        }

        const overlayCloseButton = document.querySelector('.search-background-bottom-overlay');
        if (overlayCloseButton && searchBoxElement) {
            overlayCloseButton.addEventListener('click', () => {
                setOverlayState(false);
                searchBoxElement.blur();
            });
        }

        const closeButton = document.querySelector('.close-button');
        if (closeButton && searchBoxElement) {
            closeButton.addEventListener('click', () => {
                const existingStyle = document.getElementById('gradient-animation-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                if (gradientAnimationId) {
                    cancelAnimationFrame(gradientAnimationId);
                    gradientAnimationId = null;
                }
                setOverlayState(false);
                searchBoxElement.blur();
            });
        }

        // Toggle demo searches card on info icon click
        const infoIconButton = document.querySelector('.info-icon-button');
        const infoIconWrapper = document.querySelector('.info-icon-wrapper');
        if (infoIconButton && infoIconWrapper) {
            infoIconButton.addEventListener('click', (e) => {
                e.stopPropagation();
                infoIconWrapper.classList.toggle('is-open');
            });
        }

        if (bottomOverlay && searchBoxElement) {
            bottomOverlay.addEventListener('click', () => {
                if (topOverlay && topOverlay.classList.contains('is-focused')) {
                    setOverlayState(false);
                    searchBoxElement.blur();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && topOverlay && topOverlay.classList.contains('is-focused') && searchBoxElement) {
                setOverlayState(false);
                searchBoxElement.blur();
            }
        });

        if (topOverlay && bottomOverlay) {
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    sessionStorage.setItem(OVERLAY_STATE_KEY, topOverlay.classList.contains('is-focused') ? 'true' : 'false');
                    sessionStorage.setItem(OVERLAY_RESTORE_KEY, 'true');
                } else if (document.visibilityState === 'visible') {
                    const shouldRestore = sessionStorage.getItem(OVERLAY_RESTORE_KEY) === 'true';
                    if (shouldRestore) {
                        const shouldExpand = sessionStorage.getItem(OVERLAY_STATE_KEY) === 'true';
                        setOverlayState(shouldExpand, { suppressTransition: true });
                        sessionStorage.setItem(OVERLAY_RESTORE_KEY, 'false');
                    }
                }
            });
        }

        // Debug button handlers
        const debugButtons = document.querySelectorAll('.debug-buttons .debug-button');
        const suggestionsContainer = document.querySelector('.search-suggestions-preview-column-container');
        const carrotList = document.querySelector('.search-suggestions-preview-list:last-child');
        const suggestionsList = document.querySelector('.search-suggestions-preview-list:first-child');
        
        let currentState = 0; // Track current state
        let selectedSuggestionIndex = -1; // Track selected suggestion index (only one at a time)
        
        // Fixed skeleton widths for each row position (1-10)
        const skeletonWidths = [
            Math.floor(Math.random() * 130) + 30, // Row 1
            Math.floor(Math.random() * 130) + 30, // Row 2
            Math.floor(Math.random() * 130) + 30, // Row 3
            Math.floor(Math.random() * 130) + 30, // Row 4
            Math.floor(Math.random() * 130) + 30, // Row 5
            Math.floor(Math.random() * 130) + 30, // Row 6
            Math.floor(Math.random() * 130) + 30, // Row 7
            Math.floor(Math.random() * 130) + 30, // Row 8
            Math.floor(Math.random() * 130) + 30, // Row 9
            Math.floor(Math.random() * 130) + 30  // Row 10
        ];
        
        // Mapping of demo search terms to carrot states
        const demoSearchCarrots = {
            'fox wiki': 2,        // wikipedia
            'chair': 8,          // adMarketplace
            'sneakers': 9,       // bigAd
            'uber stock': 6,     // stocks
            'ac8170': 1,         // flights
            'lakers game': 5,    // sports
            'coffee shops': 0,   // local
            'weather': 4,         // weather
            'vpn': 13,           // vpn
            'mdn': 10,           // mdn
            'array': 10,         // mdn
            'youtube': 12,       // youtube
            'time tokyo': 7,     // worldClock
            'happy emoji': 11    // happyEmoji
        };
        
        // Function to show carrot for demo searches
        const showCarrotForDemoSearch = (query) => {
            const queryLower = query.toLowerCase().trim();
            const carrotState = demoSearchCarrots[queryLower];
            
            if (carrotState !== undefined && carrotList && suggestionsContainer) {
                // Check if we need to slide in from the right
                const needsSlide = currentState !== 0 && currentState !== carrotState;
                
                if (needsSlide) {
                    // Slide out current carrot, then slide in new one
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    setTimeout(() => {
                        setCarrotContent(carrotState);
                        currentState = carrotState;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    // Just show the carrot directly
                    setCarrotContent(carrotState);
                    currentState = carrotState;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
                return true;
            }
            
            // Check if query is a prefix of any demo search (don't hide carrot while typing)
            const isPrefix = Object.keys(demoSearchCarrots).some(term => term.startsWith(queryLower));
            if (isPrefix) {
                // User is typing a demo search, don't hide carrot yet
                return false;
            }
            
            return false;
        };
        
        // Minimal iconMappings for ut.html (since suggestion-paths.js was removed)
        const iconMappings = {
            lightning: [],
            search: []
        };
        
        function getIconForSuggestion(text) {
            try {
                const textLower = text.toLowerCase();
                
                // AI suggestions always get search icon
                if (aiSuggestionsSet.has(textLower)) {
                    return 'icons/search.svg';
                }
                
                if (typeof iconMappings !== 'undefined' && iconMappings) {
                    if (iconMappings.lightning && iconMappings.lightning.includes(textLower)) {
                        return 'icons/lightning.svg';
                    } else if (iconMappings.search && iconMappings.search.includes(textLower)) {
                        return 'icons/search.svg';
                    }
                }
                return 'icons/clock.svg';
            } catch (error) {
                console.error('Error in getIconForSuggestion:', error);
                return 'icons/clock.svg';
            }
        }
        
        function showSkeletonLoaders(count = 3) {
            console.log('[Skeleton] showSkeletonLoaders called, count:', count);
            if (!suggestionsList) {
                console.log('[Skeleton] suggestionsList is null/undefined');
                return;
            }
            
            // Get current number of real suggestions (non-skeleton items)
            const existingItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item:not(.skeleton)');
            const startRowIndex = existingItems.length; // Row position where skeletons will start (0-indexed)
            
            // Generate skeletons with fixed widths based on their row positions
            const skeletonHTML = Array.from({ length: count }, (_, i) => {
                const rowPosition = startRowIndex + i; // Actual row position (0-9 for rows 1-10)
                const width = skeletonWidths[rowPosition]; // Use fixed width for this row position
                return `
                    <li class="search-suggestions-preview-item skeleton" data-index="-1">
                        <div class="suggestion-icon" style="background-color: #E5E7EB; width: 16px; height: 16px; border-radius: 2px; opacity: 0.6; display: block; flex-shrink: 0;"></div>
                        <span class="skeleton-text" style="width: ${width}px; height: 14px; background-color: #E5E7EB; border-radius: 4px; opacity: 0.6; display: block;"></span>
                    </li>
                `;
            }).join('');
            
            console.log('[Skeleton] Generated HTML:', skeletonHTML);
            console.log('[Skeleton] Current innerHTML length:', suggestionsList.innerHTML.length);
            console.log('[Skeleton] Start row index:', startRowIndex, 'Skeleton count:', count);
            
            // Append skeletons to existing suggestions
            suggestionsList.innerHTML += skeletonHTML;
            
            console.log('[Skeleton] New innerHTML length:', suggestionsList.innerHTML.length);
            console.log('[Skeleton] Number of skeleton elements:', suggestionsList.querySelectorAll('.skeleton').length);
        }
        
        function removeSkeletons() {
            if (!suggestionsList) return;
            const skeletons = suggestionsList.querySelectorAll('.skeleton');
            skeletons.forEach(skeleton => skeleton.remove());
        }
        
        function updateSuggestions(suggestions) {
            console.log('updateSuggestions called with:', suggestions);
            console.log('suggestionsList:', suggestionsList);
            if (!suggestionsList) {
                console.log('suggestionsList is null/undefined, returning early');
                return;
            }
            
            // Remove any existing skeletons when updating with real suggestions
            removeSkeletons();
            
            console.log('Sorting suggestions...');
            try {
                // Sort suggestions by icon type: lightning first, clock second, search last
                console.log('About to sort, suggestions count:', suggestions.length);
                const sortedSuggestions = [...suggestions].sort((a, b) => {
                    try {
                        const iconA = getIconForSuggestion(a);
                        const iconB = getIconForSuggestion(b);
                        
                        const iconOrder = {
                            'icons/lightning.svg': 0,
                            'icons/clock.svg': 1,
                            'icons/search.svg': 2
                        };
                        
                        const orderA = iconOrder[iconA] !== undefined ? iconOrder[iconA] : 2;
                        const orderB = iconOrder[iconB] !== undefined ? iconOrder[iconB] : 2;
                        
                        return orderA - orderB;
                    } catch (sortError) {
                        console.error('Error in sort comparison:', sortError, { a, b });
                        return 0;
                    }
                });
                
                console.log('Sorted suggestions:', sortedSuggestions.length);
                
                // Get current search value for highlighting
                const searchValue = searchBoxElement ? searchBoxElement.value.toLowerCase() : '';
                console.log('Search value for highlighting:', searchValue);
                
                console.log('Mapping suggestions to HTML...');
                const htmlString = sortedSuggestions.map((text, index) => {
                const icon = getIconForSuggestion(text);
                
                // Bold matching characters (ignore spaces in search value)
                let displayText = text;
                if (searchValue) {
                    const searchNoSpaces = searchValue.replace(/\s/g, '');
                    const textLower = text.toLowerCase();
                    const textNoSpaces = textLower.replace(/\s/g, '');
                    const matchIndex = textNoSpaces.indexOf(searchNoSpaces);
                    
                    if (matchIndex !== -1) {
                        // Find the actual position in the original text
                        let charCount = 0;
                        let startIndex = -1;
                        let endIndex = -1;
                        
                        for (let i = 0; i < text.length; i++) {
                            if (text[i] !== ' ') {
                                if (charCount === matchIndex) {
                                    startIndex = i;
                                }
                                if (charCount === matchIndex + searchNoSpaces.length - 1) {
                                    endIndex = i + 1;
                                    break;
                                }
                                charCount++;
                            }
                        }
                        
                        if (startIndex !== -1 && endIndex !== -1) {
                            const before = text.substring(0, startIndex);
                            const match = text.substring(startIndex, endIndex);
                            const after = text.substring(endIndex);
                            displayText = `${before}<strong>${match}</strong>${after}`;
                        }
                    }
                }
                
                return `
                    <li class="search-suggestions-preview-item" data-index="${index}">
                        <img src="${icon}" alt="" aria-hidden="true" class="suggestion-icon">
                        <span class="label">${displayText}</span>
                        <span class="search-hint" style="display: none;">&nbsp;•&nbsp;&nbsp;Search with Google</span>
                    </li>
                `;
                }).join('');
                
                console.log('Generated HTML length:', htmlString.length);
                console.log('Generated HTML preview:', htmlString.substring(0, 200));
                console.log('About to set innerHTML...');
                suggestionsList.innerHTML = htmlString;
                console.log('innerHTML set, new innerHTML length:', suggestionsList.innerHTML.length);
                console.log('Number of child elements:', suggestionsList.children.length);
            } catch (error) {
                console.error('Error in updateSuggestions:', error);
                console.error('Error stack:', error.stack);
            }
            
            // Reset selection when suggestions update
            selectedSuggestionIndex = -1;
            updateSelectedSuggestion();
            
            // Attach click handlers to suggestions (this clones nodes, so do it first)
            attachClickListeners();
            
            // Attach hover listeners to the new suggestions (after click listeners)
            attachHoverListeners();
            
        }
        
        function performGoogleSearch(suggestionText) {
            if (!suggestionText || !suggestionText.trim()) return;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(suggestionText.trim())}`;
            window.open(searchUrl, '_blank');
        }
        
        function attachClickListeners() {
            if (!suggestionsList) return;
            
            const suggestionItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item:not(.skeleton)');
            suggestionItems.forEach((item) => {
                // Remove existing click listener if any
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                
                // Add click handler
                newItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get the suggestion text from the label
                    const labelElement = newItem.querySelector('.label');
                    if (labelElement) {
                        // Get text content, removing any HTML tags (like <strong>)
                        const suggestionText = labelElement.textContent.trim();
                        performGoogleSearch(suggestionText);
                    }
                });
            });
        }
        
        function attachHoverListeners() {
            if (!suggestionsList) return;
            
            const suggestionItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item');
            suggestionItems.forEach((item) => {
                item.addEventListener('mouseenter', handleSuggestionHover);
            });
            
            // Clear selection when mouse leaves the suggestions list
            const suggestionsContainer = suggestionsList.closest('.search-suggestions-preview-column-container');
            if (suggestionsContainer) {
                suggestionsContainer.addEventListener('mouseleave', () => {
                    selectedSuggestionIndex = -1;
                    updateSelectedSuggestion();
                });
            }
        }
        
        function handleSuggestionHover(event) {
            if (!suggestionsList) return;
            const suggestionItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item');
            const index = Array.from(suggestionItems).indexOf(event.currentTarget);
            if (index >= 0) {
                // Hovering steals selection from keyboard-selected item
                selectedSuggestionIndex = index;
                updateSelectedSuggestion();
            }
        }
        
        function updateSelectedSuggestion(isKeyboardNavigation = false) {
            if (!suggestionsList) return;
            
            const suggestionItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item');
            
            // Remove selection from ALL items first
            suggestionItems.forEach((item) => {
                item.classList.remove('is-selected');
                // Hide "Search with Google" hint
                const hintElement = item.querySelector('.search-hint');
                if (hintElement) {
                    hintElement.style.display = 'none';
                }
            });
            
            // Then add selection to ONLY the selected item (if one is selected)
            if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                const selectedItem = suggestionItems[selectedSuggestionIndex];
                selectedItem.classList.add('is-selected');
                // Show "Search with Google" hint
                const hintElement = selectedItem.querySelector('.search-hint');
                if (hintElement) {
                    hintElement.style.display = 'inline';
                }
                
                // If this is keyboard navigation, update the search box text
                if (isKeyboardNavigation && searchBoxElement) {
                    const label = selectedItem.querySelector('.label');
                    if (label) {
                        // Extract text without HTML tags (removes <strong> tags but keeps text)
                        const suggestionText = label.textContent || label.innerText;
                        searchBoxElement.value = suggestionText.trim();
                    }
                }
            }
        }
        
        
        function setCarrotContent(state) {
            if (!carrotList) {
                return;
            }

            // Use templates from carrot-templates.js
            switch(state) {
                case 0:
                    carrotList.innerHTML = carrotTemplates.local();
                    break;
                case 1:
                    carrotList.innerHTML = carrotTemplates.flights();
                    break;
                case 2:
                    carrotList.innerHTML = carrotTemplates.wikipedia();
                    break;
                case 3:
                    carrotList.innerHTML = carrotTemplates.placeholder();
                    break;
                case 4:
                    carrotList.innerHTML = carrotTemplates.weather();
                    break;
                case 5:
                    carrotList.innerHTML = carrotTemplates.sports();
                    break;
                case 6:
                    carrotList.innerHTML = carrotTemplates.stocks();
                    break;
                case 7:
                    carrotList.innerHTML = carrotTemplates.worldClock();
                    break;
                case 8:
                    carrotList.innerHTML = carrotTemplates.adMarketplace();
                    break;
                case 9:
                    carrotList.innerHTML = carrotTemplates.bigAd();
                    break;
                case 10:
                    carrotList.innerHTML = carrotTemplates.mdn();
                    break;
                case 11:
                    carrotList.innerHTML = carrotTemplates.happyEmoji();
                    // Add click handlers for emoji copying
                    setTimeout(() => {
                        const emojiItems = carrotList.querySelectorAll('.emoji-item');
                        emojiItems.forEach(item => {
                            item.addEventListener('click', () => {
                                const emoji = item.getAttribute('data-emoji');
                                if (emoji && navigator.clipboard) {
                                    navigator.clipboard.writeText(emoji).then(() => {
                                        // Visual feedback could be added here
                                    }).catch(err => {
                                        console.error('Failed to copy emoji:', err);
                                    });
                                }
                            });
                        });
                    }, 0);
                    break;
                case 12:
                    carrotList.innerHTML = carrotTemplates.youtube();
                    break;
                case 13:
                    carrotList.innerHTML = carrotTemplates.vpn();
                    // Add toggle functionality
                    setTimeout(() => {
                        const toggleInput = carrotList.querySelector('.vpn-toggle-input');
                        const statusIndicator = carrotList.querySelector('.vpn-status-indicator');
                        const statusText = carrotList.querySelector('.vpn-status-text');
                        const vpnIndicator = document.getElementById('vpn-indicator');
                        
                        if (toggleInput) {
                            toggleInput.addEventListener('change', (e) => {
                                if (e.target.checked) {
                                    statusIndicator.classList.remove('vpn-status-indicator--off');
                                    statusIndicator.classList.add('vpn-status-indicator--on');
                                    statusText.textContent = 'VPN is on';
                                    if (vpnIndicator) {
                                        vpnIndicator.classList.add('is-active');
                                    }
                                } else {
                                    statusIndicator.classList.remove('vpn-status-indicator--on');
                                    statusIndicator.classList.add('vpn-status-indicator--off');
                                    statusText.textContent = 'VPN is off';
                                    if (vpnIndicator) {
                                        vpnIndicator.classList.remove('is-active');
                                    }
                                }
                            });
                        }
                    }, 0);
                    break;
                default:
                    console.warn(`Unknown carrot state: ${state}`);
            }

            carrotList.dataset.carrotState = String(state);
        }
        
        if (debugButtons.length > 0 && suggestionsContainer && carrotList) {
            // Button 0 (index 0): No enriched content (suggestions only)
            debugButtons[0].addEventListener('click', () => {
                currentState = 0;
                suggestionsContainer.classList.add('expand-left');
                suggestionsContainer.classList.remove('show-carrot');
            });

            // Button 1 (index 1): Local recommendations (placeholder)
            debugButtons[1].addEventListener('click', () => {
                if (currentState !== 0) {
                    // Transition to 0 first
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    // Wait for slide out, then change content while hidden, then slide in
                    setTimeout(() => {
                        setCarrotContent(0);
                        currentState = 1;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(0);
                    currentState = 1;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 2 (index 2): Flights (AC 8170)
            debugButtons[2].addEventListener('click', () => {
                if (currentState !== 0) {
                    // Transition to 0 first
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    // Wait for slide out, then change content while hidden, then slide in
                    setTimeout(() => {
                        setCarrotContent(1);
                        currentState = 2;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(1);
                    setCarrotColor(null);
                    currentState = 2;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 3 (index 3): Wikipedia
            debugButtons[3].addEventListener('click', () => {
                if (currentState !== 0) {
                    // Transition to 0 first
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    // Wait for slide out, then change content while hidden, then slide in
                    setTimeout(() => {
                        setCarrotContent(2);
                        currentState = 3;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(2);
                    setCarrotColor(null);
                    currentState = 3;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 4 (index 4): Weather
            debugButtons[4].addEventListener('click', () => {
                if (currentState !== 0) {
                    // Transition to 0 first
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    // Wait for slide out, then change content while hidden, then slide in
                    setTimeout(() => {
                        setCarrotContent(4);
                        currentState = 4;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(4);
                    setCarrotColor('green-text');
                    currentState = 4;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 5 (index 5): Sports
            debugButtons[5].addEventListener('click', () => {
                if (currentState !== 0) {
                    // Transition to 0 first
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    // Wait for slide out, then change content while hidden, then slide in
                    setTimeout(() => {
                        setCarrotContent(5);
                        currentState = 5;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(5);
                    setCarrotColor(null);
                    currentState = 5;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 6 (index 6): Stocks
            debugButtons[6].addEventListener('click', () => {
                if (currentState !== 0) {
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    setTimeout(() => {
                        setCarrotContent(6);
                        currentState = 6;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(6);
                    setCarrotColor(null);
                    currentState = 6;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });

            // Button 7 (index 7): World clock
            debugButtons[7].addEventListener('click', () => {
                if (currentState !== 0) {
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                    
                    setTimeout(() => {
                        setCarrotContent(7);
                        currentState = 7;
                        suggestionsContainer.classList.remove('expand-left');
                        suggestionsContainer.classList.add('show-carrot');
                    }, 400);
                } else {
                    setCarrotContent(7);
                    setCarrotColor(null);
                    currentState = 7;
                    suggestionsContainer.classList.remove('expand-left');
                    suggestionsContainer.classList.add('show-carrot');
                }
            });
        }

        const flightNumberPattern = /ac\s*8170/i;

        if (searchBoxElement && suggestionsContainer && carrotList) {
            searchBoxElement.addEventListener('focus', () => {
                if (currentState !== 0 || suggestionsContainer.classList.contains('show-carrot')) {
                    setCarrotContent(0);
                    currentState = 0;
                    suggestionsContainer.classList.add('expand-left');
                    suggestionsContainer.classList.remove('show-carrot');
                }
            });

            searchBoxElement.addEventListener('keydown', (event) => {
                if (!suggestionsList) return;
                
                const suggestionItems = suggestionsList.querySelectorAll('.search-suggestions-preview-item');
                if (suggestionItems.length === 0) return;
                
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    // Keyboard navigation steals selection from hovered item
                    // If nothing is selected, select the first item (index 0)
                    // Otherwise, move down one
                    if (selectedSuggestionIndex < 0) {
                        selectedSuggestionIndex = 0;
                    } else {
                        selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestionItems.length;
                    }
                    updateSelectedSuggestion(true); // true = keyboard navigation
                    // Scroll into view if needed
                    if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                        suggestionItems[selectedSuggestionIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    // Keyboard navigation steals selection from hovered item
                    // If nothing is selected, select the last item
                    // Otherwise, move up one
                    if (selectedSuggestionIndex < 0) {
                        selectedSuggestionIndex = suggestionItems.length - 1;
                    } else if (selectedSuggestionIndex <= 0) {
                        selectedSuggestionIndex = suggestionItems.length - 1;
                    } else {
                        selectedSuggestionIndex--;
                    }
                    updateSelectedSuggestion(true); // true = keyboard navigation
                    // Scroll into view if needed
                    if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                        suggestionItems[selectedSuggestionIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                } else if (event.key === 'Enter' && selectedSuggestionIndex >= 0) {
                    event.preventDefault();
                    // Use the search box value (which should be updated by keyboard navigation)
                    const searchText = searchBoxElement.value.trim();
                    if (searchText) {
                        performGoogleSearch(searchText);
                    }
                }
            });


            // Show/hide clear button based on input value
            const updateClearButton = () => {
                if (searchClearButton && searchBoxElement) {
                    if (searchBoxElement.value.trim().length > 0) {
                        searchClearButton.style.display = 'flex';
                    } else {
                        searchClearButton.style.display = 'none';
                    }
                }
            };

            // Clear button click handler
            if (searchClearButton) {
                searchClearButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (searchBoxElement) {
                        searchBoxElement.value = '';
                        searchBoxElement.focus();
                        // Reset to default suggestions
                        updateSuggestions([
                            'hoka',
                            'macbook',
                            '13 in macbook air',
                            'Coffee machines for sale',
                            'taylor swift',
                            'coffee grinder',
                            'gmail'
                        ]);
                        // Clear AI suggestions tracking
                        aiSuggestionsSet.clear();
                        // Remove skeletons
                        removeSkeletons();
                        // Clear any pending API calls
                        if (apiCallTimer) {
                            clearTimeout(apiCallTimer);
                            apiCallTimer = null;
                        }
                        lastApiQuery = '';
                        // Clear carrot state
                        if (suggestionsContainer) {
                            suggestionsContainer.classList.remove('show-carrot');
                            suggestionsContainer.classList.add('expand-left');
                        }
                        currentState = 0;
                        if (carrotList) {
                            carrotList.innerHTML = '';
                            carrotList.dataset.carrotState = '0';
                        }
                        updateClearButton();
                    }
                });
            }

            // Update clear button on input
            searchBoxElement.addEventListener('input', (event) => {
                updateClearButton();
                const value = (event.target.value || '').toString();
                const valueLower = value.toLowerCase();
                
                // Check if this matches a demo search that should show a carrot
                const matchedCarrot = showCarrotForDemoSearch(valueLower);
                
                if (!matchedCarrot && valueLower.trim().length === 0) {
                    // Clear carrot when field is empty
                    if (suggestionsContainer) {
                        suggestionsContainer.classList.remove('show-carrot');
                        suggestionsContainer.classList.add('expand-left');
                    }
                    currentState = 0;
                    if (carrotList) {
                        carrotList.innerHTML = '';
                        carrotList.dataset.carrotState = '0';
                    }
                } else if (!matchedCarrot && valueLower.trim().length > 0) {
                    // Check if this could be a prefix of a demo search
                    const couldBeDemoSearch = Object.keys(demoSearchCarrots).some(term => term.startsWith(valueLower));
                    
                    if (!couldBeDemoSearch && suggestionsContainer && suggestionsContainer.classList.contains('show-carrot')) {
                        // User is typing something that's not a demo search, hide carrot
                        suggestionsContainer.classList.remove('show-carrot');
                        suggestionsContainer.classList.add('expand-left');
                        currentState = 0;
                        if (carrotList) {
                            carrotList.innerHTML = '';
                            carrotList.dataset.carrotState = '0';
                        }
                    }
                }
                
                console.log('Input event:', { value, valueLower, length: valueLower.length });
                console.log('suggestionWords defined?', typeof suggestionWords !== 'undefined');
                console.log('suggestionWords value:', typeof suggestionWords !== 'undefined' ? suggestionWords : 'undefined');
                
                // Check for 1-2 character suggestions from suggestionWords
                if (valueLower.length === 1) {
                    console.log('Processing 1 character:', valueLower);
                    // For single character, look for all two-character keys starting with that character
                    const matchingSuggestions = [];
                    if (typeof suggestionWords !== 'undefined' && suggestionWords) {
                        console.log('suggestionWords is available, searching keys...');
                        Object.keys(suggestionWords).forEach(key => {
                            if (key.startsWith(valueLower)) {
                                matchingSuggestions.push(...suggestionWords[key]);
                            }
                        });
                        console.log('Found matching suggestions:', matchingSuggestions.length);
                        // Limit to first 10 suggestions
                        if (matchingSuggestions.length > 0) {
                            const suggestionsToShow = matchingSuggestions.slice(0, 10);
                            console.log('Updating suggestions with:', suggestionsToShow);
                            updateSuggestions(suggestionsToShow);
                            return;
                        } else {
                            console.log('No matching suggestions found');
                        }
                    } else {
                        console.log('suggestionWords is not available');
                    }
                } else if (valueLower.length === 2) {
                    console.log('Processing 2 characters:', valueLower);
                    // For two characters, use exact match
                    if (typeof suggestionWords !== 'undefined' && suggestionWords && suggestionWords[valueLower]) {
                        console.log('Found exact match:', suggestionWords[valueLower]);
                        updateSuggestions(suggestionWords[valueLower]);
                        return;
                    } else {
                        console.log('No exact match found for:', valueLower);
                    }
                } else if (valueLower.length >= 3) {
                    console.log('Processing 3+ characters:', valueLower);
                    
                    // Clear any pending API call
                    if (apiCallTimer) {
                        clearTimeout(apiCallTimer);
                    }
                    
                    // Clear AI suggestions tracking and skeletons when query changes
                    if (lastApiQuery && lastApiQuery !== valueLower) {
                        aiSuggestionsSet.clear();
                    }
                    
                    // Always remove skeletons before updating suggestions
                    removeSkeletons();
                    
                    // Show immediate local results while waiting for AI
                    let localSuggestions = [];
                    if (typeof suggestionWords !== 'undefined' && suggestionWords) {
                        const allSuggestions = [];
                        Object.values(suggestionWords).forEach(suggestions => {
                            allSuggestions.push(...suggestions);
                        });
                        
                        // Filter to only suggestions that start with the query (word-start matching)
                        const filtered = allSuggestions.filter(suggestion => {
                            const suggestionLower = suggestion.toLowerCase();
                            // Check if suggestion starts with query
                            if (suggestionLower.startsWith(valueLower)) {
                                return true;
                            }
                            // Check if any word in the suggestion starts with the query
                            const words = suggestionLower.split(/\s+/);
                            return words.some(word => word.startsWith(valueLower));
                        });
                        
                        localSuggestions = [...new Set(filtered)];
                        if (localSuggestions.length > 0) {
                            const localCount = Math.min(localSuggestions.length, 10);
                            // Update suggestions with filtered list (this will clear old suggestions)
                            updateSuggestions(localSuggestions.slice(0, localCount));
                            // Show skeleton loaders to fill up to 10 total
                            const skeletonCount = 10 - localCount;
                            if (skeletonCount > 0) {
                                showSkeletonLoaders(skeletonCount);
                            }
                        } else {
                            // If no local suggestions, clear list and show 10 skeletons
                            updateSuggestions([]);
                            showSkeletonLoaders(10);
                        }
                    } else {
                        // If no suggestionWords available, clear list and show 10 skeletons
                        updateSuggestions([]);
                        showSkeletonLoaders(10);
                    }
                    
                    // Debounce API call (wait 300ms after user stops typing)
                    apiCallTimer = setTimeout(async () => {
                        // Only make API call if query hasn't changed
                        if (searchBoxElement.value.toLowerCase() === valueLower) {
                            lastApiQuery = valueLower;
                            console.log('Fetching AI suggestions for:', valueLower);
                            
                            const aiSuggestions = await fetchAISuggestions(valueLower);
                            
                            // Only update if query hasn't changed during API call
                            if (searchBoxElement.value.toLowerCase() === valueLower && aiSuggestions.length > 0) {
                                console.log('AI suggestions received:', aiSuggestions);
                                
                                // Track AI suggestions for icon assignment
                                aiSuggestions.forEach(aiSuggestion => {
                                    aiSuggestionsSet.add(aiSuggestion.toLowerCase());
                                });
                                
                                // Merge local and AI suggestions, removing duplicates
                                const allSuggestions = [...localSuggestions];
                                aiSuggestions.forEach(aiSuggestion => {
                                    const aiLower = aiSuggestion.toLowerCase();
                                    // Only add if not already in local suggestions
                                    if (!allSuggestions.some(s => s.toLowerCase() === aiLower)) {
                                        allSuggestions.push(aiSuggestion);
                                    }
                                });
                                
                                // Limit to 10 total suggestions
                                const mergedSuggestions = allSuggestions.slice(0, 10);
                                console.log('Merged suggestions (local + AI):', mergedSuggestions);
                                updateSuggestions(mergedSuggestions);
                            }
                        }
                    }, 300);
                }

                // Reset to default suggestions when field is empty
                if (!value.trim()) {
                    console.log('Field is empty, resetting to default suggestions');
                    // Clear AI suggestions tracking when field is empty
                    aiSuggestionsSet.clear();
                    updateSuggestions([
                        'hoka',
                        'macbook',
                        '13 in macbook air',
                        'Coffee machines for sale',
                        'taylor swift',
                        'coffee grinder',
                        'gmail'
                    ]);
                    return;
                }
                
                console.log('No suggestions updated, continuing...');
            });
        }

        const overlayScrollTarget = searchContainer;
        if (overlayScrollTarget) {
            const handleOverlayScrollWheel = (event) => {
                const maxScroll = overlayScrollTarget.scrollHeight - overlayScrollTarget.clientHeight;
                if (maxScroll <= 0) {
                    return;
                }

                const currentScroll = overlayScrollTarget.scrollTop;
                const nextScroll = currentScroll + event.deltaY;

                if ((event.deltaY < 0 && currentScroll <= 0) || (event.deltaY > 0 && currentScroll >= maxScroll)) {
                    return;
                }

                event.preventDefault();
                overlayScrollTarget.scrollTop = Math.min(Math.max(nextScroll, 0), maxScroll);
            };

            const previewArea = document.querySelector('.search-suggestions-preview');
            if (previewArea) {
                previewArea.addEventListener('wheel', handleOverlayScrollWheel, { passive: false });
            }

            overlayScrollTarget.addEventListener('wheel', handleOverlayScrollWheel, { passive: false });
        }

        const bottomPane = document.querySelector('.pane--bottom');
        if (bottomPane && topOverlay) {
            const handleOverlayPosition = () => {
                if (topOverlay.classList.contains('is-focused')) {
                    return;
                }
                bottomOverlay.style.top = `${Math.max(130, 130 + bottomPane.scrollTop)}px`;
            };
            bottomPane.addEventListener('scroll', handleOverlayPosition, { passive: true });
        }
    </script>
</body>
</html>
