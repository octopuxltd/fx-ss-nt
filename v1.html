<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype Desktop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, #1E90FF, #32CD32, #FFD700);
            font-family: 'Inter', sans-serif;
        }
        .browser-window {
            width: 80%;
            height: 90%;
            background-color: #ffffff;
            border: 1px solid rgba(128, 128, 128, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
            z-index: 1;
        }
        .tab-strip {
            height: 44px;
            background-color: #F0F0F4;
            border-radius: 12px 12px 0 0;
            box-sizing: border-box;
            z-index: 10;
            width: 100%;
        }
        .toolbar {
            height: 40px;
            background-color: #F9F9FB;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 9px; /* Adjusted padding to fit while keeping contents aligned */
            width: calc(100% - 0px); /* Zero to compensate for default border or margin */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        .toolbar-left {
            display: flex;
            gap: 8px;
        }

        .toolbar-right {
            display: flex;
            margin-left: auto;
            gap: 8px;
        }

        .toolbar-icon {
            width: 32px;
            height: 32px;
            background-color: transparent;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        .toolbar-icon svg {
            width: 24px;
            height: 24px;
        }

        .reload-icon svg {
            width: 28px;
            height: 28px;
        }

        .hamburger-menu svg {
            width: 30px;
            height: 24px;
        }

        .toolbar-icon:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .toolbar-icon img {
            position: relative;
            top: 0px;
            left: 0px;
        }

        #hamburger-icon {
            position: relative;
            top: -1px;
            left: -1px;
        }

        .address-bar {
            flex: none;
            height: 32px;
            border-radius: 8px; /* Corrected border radius */
            background-color: #E9E9EB;
            border: none;
            padding: 0 8px;
            margin-left: 16px;
            width: 50%;
            font-size: 14px;
            padding-top: 2px; /* Move placeholder to correct position */
        }

        .search-box {
            box-sizing: border-box;
            width: 100%;
            max-width: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            padding-top: 12px;
            padding-bottom: 12px;
            padding-left: 10px;
            padding-right: 10px;
            border: none;
        }

        .address-bar::placeholder,
        .search-box::placeholder {
            color: #A9A9A9;
        }

        .address-bar:focus::placeholder,
        .search-box:focus::placeholder {
            color: #A9A9A9;
        }

        .search-box:focus {
            outline: 1px solid #007BFF; /* Thinner blue highlight */
        }

        .spacer {
            flex-grow: 1;
        }
        .viewport {
            flex: 1;
            background-color: #DCF5FA;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            border-radius: 0 0 12px 12px;
            position: relative;
        }
        .viewport-inner {
            width: 100%;
            background-color: #92DFEC;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            padding-bottom: 32px;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 26px;  /* Increase gap by 30% from 20px to 26px */
            width: 70%;
            max-width: 1200px;
            box-sizing: border-box;
        }

        .card {
            background-color: #FFFFFF;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            height: 275px;
            transition: box-shadow 0.15s ease-in-out;
        }

        .card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .card h2 {
            margin: 16px;
            font-size: 18px;
            text-align: left;
            color: #333;
            font-weight: 500;
            flex-grow: 1;
        }

        .card p {
            margin-left: 16px;
            font-size: 12px;
            text-align: left;
            color: #777;  /* Lighter grey color */
        }
        .image-placeholder {
            width: 100%;
            height: 160px;
            background-color: #CCC;
        }
        a.card {
            text-decoration: none !important;
            color: inherit !important;
            display: block;
        }
        .card:hover h2 {
            color: #1E90FF;  /* Blue color on hover */
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .heading {
            font-size: 16px;  /* Reduced size */
            font-weight: bold;
            text-align: left;
            margin: 0;
            padding-top: 48px;  /* Triple the previous space */
            padding-bottom: 24px;
            width: 70%;  /* Align with the grid */
            max-width: 1200px;
        }
        .search-background {
            width: 100%;
            background-color: rgba(255, 255, 255, 0);
            justify-content: center;
            align-items: top;
            position: sticky;
            top: 0;
            z-index: 1000;
            overflow: hidden;
            border-bottom: 1px solid rgba(0, 0, 0, 0);
            transition: height 0.35s ease-in-out,
                        background-color 0.35s ease-in-out,
                        margin-bottom 0.35s ease-in-out,
                        border-bottom-color 0.35s ease-in-out;
        }

        .search-box {
            width: calc(0.8 * 70%); /* 80% of the grid's 70% width */
            max-width: none;
            padding: 18px 18px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }
        .search-dropdown-button {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 8px;
            background-color: #DADADC;
            margin-right: 10px;
        }

        .circle-icon {
            width: 18px;  /* Increase size by 50% */
            height: 18px; /* Increase size by 50% */
            margin-right: 4px;
        }

        .chevron {
            padding-top:3px;
            width: 12px;
            height: 12px;
            margin-left: 4px; 
        }
        .search-wrapper {
            position: relative;
            width: 56%;
            margin: 34px auto 40px;
            transition: width 0.35s ease-in-out;
        }

        .search-close-button {
            position: absolute;
            top: 0;
            right: 24px;
            width: 56px;
            height: 56px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.2s ease-in-out;
        }

        .search-close-button.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .search-close-button:focus {
            outline: none;
        }

        .search-close-button img {
            width: 100%;
            height: 100%;
        }

        .search-suggestions {
            position: absolute;
            top: calc(100% + 12px);
            left: 0;
            width: 100%;
            display: none;
            flex-direction: column;
            gap: 0;
            border-radius: 16px;
            background: #FFFFFF;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            transition: width 0.35s ease-in-out, opacity 0.2s ease-in-out;
            z-index: 10;
        }

        .search-suggestions.is-visible {
            display: flex;
        }

        .suggestion-heading {
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0;
            text-transform: none;
            color: #6B7280;
            margin: 14px 18px 0;
            padding: 0;
            display: block;
        }

        .suggestions-content {
            display: flex;
            gap: 16px;
            padding: 8px 18px 18px;
            overflow: hidden;
        }

        .search-suggestions-list {
            list-style: none;
            margin: 0;
            padding: 4px 0;
            flex: 1 1 100%;
            transition: flex-basis 0.3s ease-out;
        }

        .suggestions-content.has-product .search-suggestions-list {
            flex: 1 1 calc(50% - 12px);
        }

        .suggestion-product-card {
            display: flex;
            flex: 0 0 0;
            align-items: stretch;
            transform: translateX(110%);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out, visibility 0s linear 0.4s, flex-basis 0.3s ease-out;
        }

        .suggestions-content.has-product .suggestion-product-card {
            flex: 0 0 calc(50% - 12px);
        }

        .suggestion-product-card.is-visible {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }

        .suggestion-product-card-link {
            display: flex;
            flex-direction: column;
            background: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: inherit;
            transition: box-shadow 0.15s ease-in-out;
            transform: scale(0.82);
            transform-origin: center;
        }

        .suggestion-product-card.is-visible .suggestion-product-card-link {
            transform: scale(0.78);
        }

        .suggestion-product-card-link:hover,
        .suggestion-product-card-link:focus {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .suggestion-product-card-link img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }

        .suggestion-product-card-body {
            padding: 14px 16px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .suggestion-product-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1F2933;
        }

        .suggestion-product-meta {
            margin: 0;
            font-size: 13px;
            color: #6B7280;
        }

        .suggestion-item {
            padding: 4px 12px;
        }

        .suggestion-item:first-child {
            padding-top: 8px;
        }

        .suggestion-item:last-child {
            padding-bottom: 8px;
        }

        .suggestion-primary {
            font-size: 14px;
            font-weight: 500;
            color: #1F2933;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.15s ease-in-out;
        }

        .suggestion-item:hover .suggestion-primary,
        .suggestion-item:focus-within .suggestion-primary {
            background-color: rgba(15, 23, 42, 0.08);
        }

        .suggestion-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            opacity: 0.65;
            margin-left: -8px;
        }

        .suggestion-icon-search {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: -8px;
        }

        .suggestion-icon-search::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            border: 2px solid #4B5563;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .suggestion-icon-search::after {
            content: '';
            display: block;
            width: 6px;
            height: 2px;
            background-color: #4B5563;
            border-radius: 1px;
            transform: rotate(35deg);
            transform-origin: left center;
            margin-left: -2px;
            margin-top: 6px;
        }

        .search-suggestions-products {
            display: none;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 26px;
            padding: 20px 18px 24px;
            width: 70%;
            max-width: 1200px;
            margin: 18px auto 0;
            max-height: var(--product-row-height, 295px);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            scrollbar-width: none;
        }

        .search-suggestions-products::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .product-card {
            background: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.15s ease-in-out;
            text-decoration: none !important;
            color: inherit !important;
            flex: 1;
            min-height: 0;
            height: 100%;
        }

        .product-card.is-hidden {
            display: none;
        }

        .product-card:hover,
        .product-card:focus {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .product-card:hover .product-title,
        .product-card:focus .product-title {
            color: #1E90FF;
        }

        .product-image {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            flex: 0 0 auto;
        }

        .product-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
        }

        .product-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .product-link-list {
            display: none;
            flex-direction: column;
            gap: 10px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .product-link-list li {
            background: #F5F7FA;
            border-radius: 10px;
            overflow: hidden;
        }

        .product-link-list.is-visible {
            display: flex;
        }

        .product-link-list li a {
            display: block;
            color: #1F2933;
            text-decoration: none;
            font-size: 14px;
            padding: 10px 12px;
            border-radius: 10px;
        }

        .product-link-list li a:hover,
        .product-link-list li a:focus {
            text-decoration: underline;
        }

        .product-heading--placeholder {
            visibility: hidden;
        }

        .product-heading {
            margin: 0;
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0;
            text-transform: none;
            color: #6B7280;
        }

        .product-title {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            color: #1F2933;
            flex-grow: 1;
        }

        .product-meta {
            margin: 0;
            font-size: 12px;
            color: #777777;
        }

        .search-suggestions-products.is-visible {
            display: grid;
        }

        .search-dropdown-button {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .search-box {
            width: 100%;
            padding-left: 74px; /* Increase padding to make room for dropdown button */
            border-radius: 16px; /* Increase corner radius */
        }

        .search-dropdown-button {
            height: 18px;
            padding-top: 8px; /* Match the padding to left padding */
            padding-bottom: 8px; /* Match the padding to left padding */
        }

        .viewport-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s linear;
            z-index: 500;
        }

        .viewport-overlay.is-visible {
            opacity: 1;
        }

        .search-background-bottom-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 0;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }

        .search-background-bottom-overlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .search-background-bottom-overlay:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .search-background-bottom-overlay svg {
            display: block;
        }

        .search-background-bottom-overlay .chevron-shallow {
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }

        .search-background-bottom-overlay .chevron-steep {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .search-background-bottom-overlay:hover .chevron-shallow {
            opacity: 0;
        }

        .search-background-bottom-overlay:hover .chevron-steep {
            opacity: 1;
        }
    </style>
</head>
<body>
        <div class="viewport">
            <div class="viewport-overlay" aria-hidden="true"></div>
            <div class="viewport-inner">
                <div class="search-background">
                    <!-- NOTE: Do not delete this X icon - it's commented out but may be needed in the future -->
                    <!-- <button class="search-close-button" type="button" aria-label="Close search">
                        <img src="icons/close.svg" alt="">
                    </button> -->
                    <div class="search-wrapper">
                        <div class="search-dropdown-button">
                            <img src="icons/circle.svg" alt="Circle" class="circle-icon">
                            <img src="icons/chevron.svg" alt="Chevron" class="chevron">
                        </div>
                        <input type="text" class="search-box" placeholder="Search the web">
                        <div class="search-suggestions" aria-hidden="true">
                            <span class="suggestion-heading">Recent Searches</span>
                            <div class="suggestions-content">
                                <ul class="search-suggestions-list"></ul>
                                <div class="suggestion-product-card" aria-hidden="true">
                                    <a href="#" class="suggestion-product-card-link">
                                        <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&amp;fit=crop&amp;w=600&amp;q=80" alt="HOKA Clifton 9 Sneaker" class="suggestion-product-image">
                                        <div class="suggestion-product-card-body">
                                            <h3 class="suggestion-product-title">HOKA Clifton 9</h3>
                                            <p class="suggestion-product-meta">Women’s road running shoe · New arrival</p>
                    </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-suggestions-products" aria-hidden="true">
                        <div class="product-column">
                            <p class="product-heading">From your history</p>
                            <a href="#" class="product-card">
                                <img src="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=600&q=80" alt="Nike Pegasus Trail" class="product-image">
                                <div class="product-body">
                                    <h3 class="product-title">Nike Pegasus Trail</h3>
                                    <p class="product-meta">Trail Running Shoes</p>
                                </div>
                            </a>
                        </div>
                        <div class="product-column">
                            <p class="product-heading">Recent sessions</p>
                            <a href="#" class="product-card">
                                <img src="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=80" alt="13-inch MacBook Air" class="product-image">
                                <div class="product-body">
                                    <h3 class="product-title">13" MacBook Air</h3>
                                    <p class="product-meta">Midnight · Apple M3</p>
                                </div>
                            </a>
                        </div>
                        <div class="product-column product-column--links">
                            <p class="product-heading product-heading--placeholder" aria-hidden="true">&nbsp;</p>
                            <a href="#" class="product-card product-card--primary">
                                <img src="https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=600&q=80" alt="Fellow Stagg EKG Kettle" class="product-image">
                                <div class="product-body">
                                    <h3 class="product-title">Fellow Stagg EKG Kettle</h3>
                                    <p class="product-meta">Pour-over Electric Kettle</p>
                                </div>
                            </a>
                            <ul class="product-link-list" aria-hidden="true"></ul>
                        </div>
                        <div class="product-column">
                            <p class="product-heading">Trending</p>
                            <a href="#" class="product-card">
                                <img src="https://images.unsplash.com/photo-1447933601403-0c6688de566e?auto=format&fit=crop&w=600&q=80" alt="Breville Barista Express" class="product-image">
                                <div class="product-body">
                                    <h3 class="product-title">Breville Barista Express</h3>
                                    <p class="product-meta">Espresso Machine</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    <button class="search-background-bottom-overlay" type="button" aria-label="Close search" aria-hidden="true">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="chevron-shallow" d="M4 20L16 15L28 20" stroke="#6B7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path class="chevron-steep" d="M6 20L16 12L26 20" stroke="#6B7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
                        </svg>
                    </button>
                </div>
                <h1 class="heading">Thought-provoking stories</h1>
                <div class="articles-grid">
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Surprising Science Behind Lightning</h2>
                    <p>SELF G</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Ten People Go on Trial in Paris</h2>
                    <p>The Guardian</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Can Dogs Sense Ghosts?</h2>
                    <p>Popular Science</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>11 One-Pot Gut-Healthy Dinners</h2>
                    <p>Eating Well</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Dark Side of Mirrors in Space</h2>
                    <p>Nautilus</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>UK Regional Airline Suspends Ops</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The Internet Is Going to Break Again</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>The 1 Surprising Snack People Eat</h2>
                    <p>Eating Well</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Reclaiming 72 Hours a Week</h2>
                    <p>Sky</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Hidden Dangers in Fast Food</h2>
                    <p>Health Digest</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Exploring Virtual Reality</h2>
                    <p>Tech Today</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Unveiling the Quantum Age</h2>
                    <p>Scientific Insights</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Breakthroughs in Renewable Energy</h2>
                    <p>Eco World</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Astronomy's New Frontiers</h2>
                    <p>Space Observer</p>
                </a>
                <a href="#" class="card">
                    <div class="image-placeholder"></div>
                    <h2>Innovative Designs in Architecture</h2>
                    <p>Modern Home</p>
                </a>
            </div>
        </div>
    <script>
        // Logging helper function
        const log = function() {
            if (typeof window !== 'undefined' && window.console && window.console.log) {
                window.console.log.apply(window.console, arguments);
            }
        };
        
        log('=== SCRIPT STARTED ===');
        
        const apiKey = 'bCm88s2aE42pgTVWHJn6CRvAf916qPGquNowlZue6tSbVSImQ0hdsWSX';
        const keywords = [
            'UTI', 'trial Paris', 'ghosts',
            'healthy dinner', 'mirrors space', 'UK airline',
            'internet', 'snack', 'productivity',
            'fast food', 'virtual reality', 'quantum physics',
            'renewable energy', 'astronomy', 'architecture'
        ];

        const fetchImages = async () => {
            const imageUrls = [];
            for (const keyword of keywords) {
                const response = await fetch(`https://api.pexels.com/v1/search?query=${keyword}&per_page=1`, {
                    headers: {
                        Authorization: apiKey
                    }
                });
                const data = await response.json();
                const photoUrl = data.photos[0] ? data.photos[0].src.medium : 'https://via.placeholder.com/300';
                imageUrls.push(photoUrl);
            }
            return imageUrls;
        };

        const updateImages = async () => {
            const images = await fetchImages();
            const imagePlaceholders = document.querySelectorAll('.image-placeholder');
            imagePlaceholders.forEach((placeholder, index) => {
                const img = document.createElement('img');
                img.src = images[index] || placeholder.dataset.placeholder;
                img.style.width = '100%';
                img.style.height = '160px';
                img.style.objectFit = 'cover';
                placeholder.replaceWith(img);
            });
        };

        document.addEventListener('DOMContentLoaded', updateImages);

        const searchBox = document.querySelector('.search-box');
        const searchBackground = document.querySelector('.search-background');
        const browserWindow = document.querySelector('.browser-window');
        const viewport = document.querySelector('.viewport');
        const searchWrapper = document.querySelector('.search-wrapper');
        const searchCloseButton = document.querySelector('.search-close-button');
        const searchSuggestions = document.querySelector('.search-suggestions');
        const suggestionsHeadingElement = document.querySelector('.suggestion-heading');
        const suggestionsListElement = document.querySelector('.search-suggestions-list');
        const suggestionsContentElement = document.querySelector('.suggestions-content');
        const searchSuggestionsProducts = document.querySelector('.search-suggestions-products');
        const viewportOverlay = document.querySelector('.viewport-overlay');
        const suggestionProductCard = document.querySelector('.suggestion-product-card');
        const searchBackgroundBottomOverlay = document.querySelector('.search-background-bottom-overlay');

        const recentSearches = [
            'hoka',
            'macbook',
            '13 in macbook air',
            'Coffee machines for sale',
            'coffee',
            'coffee grinder'
        ];

        const allSuggestions = [
            'HOKA running shoes',
            'Hydration packs for hiking',
            'Hill repeat workouts',
            'Healthy homemade snacks',
            'Half marathon playlist',
            'How to tie running shoes',
            'Hoop skirt',
            'House paint',
            'Home Office Dashboard',
            'Hot Ones show',
            'Horizon Zero Dawn',
            'Hong Kong travel guide',
            'Honey recipes',
            'Hockey equipment',
            'Holiday destinations',
            'Home renovation ideas',
            'Horseback riding lessons',
            'Horticulture tips',
            'Hologram technology',
            'Hospitality industry trends'
        ];

        const suggestionPresets = {
            'hoka': [
                'HOKA running shoes',
                'Hydration packs for hiking',
                'Hill repeat workouts',
                'Healthy homemade snacks',
                'Half marathon playlist',
                'How to tie running shoes'
            ],
            'hok': [
                'HOKA running shoes',
                'Hydration packs for hiking',
                'Hill repeat workouts',
                'Healthy homemade snacks',
                'Half marathon playlist',
                'How to tie running shoes'
            ],
            'ho': [
                'HOKA running shoes',
                'Hydration packs for hiking',
                'Hill repeat workouts',
                'Healthy homemade snacks',
                'Half marathon playlist',
                'How to tie running shoes'
            ]
        };

        const productOverrides = {
            '': null,
            'h': null,
            'ho': {
                first: {
                    title: 'Hoop skirt',
                    meta: 'Vintage-style silhouette',
                    image: {
                        src: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?auto=format&fit=crop&w=600&q=80',
                        alt: 'Hoop skirt display'
                    }
                },
                second: {
                    title: 'House paint',
                    meta: 'Interior matte finish · 5L',
                    image: {
                        src: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=600&q=80',
                        alt: 'Paint cans and brush'
                    }
                },
                thirdHeading: 'Recent sessions',
                thirdLinks: [
                    { label: 'Home Office Dashboard – Notion', href: '#' },
                    { label: 'Holodeck VR Labs – Booking', href: '#' },
                    { label: 'Horizon Zero Dawn Wiki', href: '#' },
                    { label: 'Hot Ones | Season 21 Trailer', href: '#' }
                ]
            },
            'hok': {
                first: {
                    title: 'Hoop skirt',
                    meta: 'Vintage-style silhouette',
                    image: {
                        src: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?auto=format&fit=crop&w=600&q=80',
                        alt: 'Hoop skirt display'
                    }
                },
                second: {
                    title: 'House paint',
                    meta: 'Interior matte finish · 5L',
                    image: {
                        src: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=600&q=80',
                        alt: 'Paint cans and brush'
                    }
                },
                thirdHeading: 'Recent sessions',
                thirdLinks: [
                    { label: 'Home Office Dashboard – Notion', href: '#' },
                    { label: 'Holodeck VR Labs – Booking', href: '#' },
                    { label: 'Horizon Zero Dawn Wiki', href: '#' },
                    { label: 'Hot Ones | Season 21 Trailer', href: '#' }
                ]
            },
            'hoka': {
                first: {
                    title: 'Hoop skirt',
                    meta: 'Vintage-style silhouette',
                    image: {
                        src: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?auto=format&fit=crop&w=600&q=80',
                        alt: 'Hoop skirt display'
                    }
                },
                second: {
                    title: 'House paint',
                    meta: 'Interior matte finish · 5L',
                    image: {
                        src: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=600&q=80',
                        alt: 'Paint cans and brush'
                    }
                },
                thirdHeading: 'Recent sessions',
                thirdLinks: [
                    { label: 'Home Office Dashboard – Notion', href: '#' },
                    { label: 'Holodeck VR Labs – Booking', href: '#' },
                    { label: 'Horizon Zero Dawn Wiki', href: '#' },
                    { label: 'Hot Ones | Season 21 Trailer', href: '#' }
                ]
            }
        };

        const applyProductOverrides = (presetKey) => {
            const overrides = productOverrides[presetKey];
            const columns = Array.from(document.querySelectorAll('.search-suggestions-products .product-column'));
            
            if (!columns || columns.length === 0) {
                return;
            }

            const defaultProducts = [
                {
                    heading: 'From your history',
                    title: 'Nike Pegasus Trail',
                    meta: 'Trail Running Shoes',
                    image: {
                        src: 'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=600&q=80',
                        alt: 'Nike Pegasus Trail'
                    }
                },
                {
                    heading: 'Recent sessions',
                    title: '13" MacBook Air',
                    meta: 'Midnight · Apple M3',
                    image: {
                        src: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=80',
                        alt: '13-inch MacBook Air'
                    }
                },
                {
                    heading: '',
                    title: 'Fellow Stagg EKG Kettle',
                    meta: 'Pour-over Electric Kettle',
                    image: {
                        src: 'https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=600&q=80',
                        alt: 'Fellow Stagg EKG Kettle'
                    }
                },
                {
                    heading: 'Trending',
                    title: 'Breville Barista Express',
                    meta: 'Espresso Machine',
                    image: {
                        src: 'https://images.unsplash.com/photo-1447933601403-0c6688de566e?auto=format&fit=crop&w=600&q=80',
                        alt: 'Breville Barista Express'
                    }
                }
            ];

            columns.forEach((column, index) => {
                const headingElement = column.querySelector('.product-heading');
                const titleElement = column.querySelector('.product-title');
                const metaElement = column.querySelector('.product-meta');
                const imageElement = column.querySelector('.product-image');
                const cardElement = column.querySelector('.product-card');
                const linkListElement = column.querySelector('.product-link-list');

                const resetHeading = (text, isPlaceholder = false) => {
                    if (!headingElement) {
                        return;
                    }
                    headingElement.textContent = text;
                    if (isPlaceholder) {
                        headingElement.classList.add('product-heading--placeholder');
                        headingElement.setAttribute('aria-hidden', 'true');
                    } else {
                        headingElement.classList.remove('product-heading--placeholder');
                        headingElement.removeAttribute('aria-hidden');
                    }
                };

                const showCard = () => {
                    if (cardElement) {
                        cardElement.classList.remove('is-hidden');
                    }
                    if (linkListElement) {
                        linkListElement.classList.remove('is-visible');
                        linkListElement.setAttribute('aria-hidden', 'true');
                        linkListElement.innerHTML = '';
                    }
                };

                const showLinkList = (links = []) => {
                    if (!linkListElement) {
                        return;
                    }
                    linkListElement.innerHTML = '';
                    links.forEach((link) => {
                        const li = document.createElement('li');
                        const anchor = document.createElement('a');
                        anchor.href = link.href || '#';
                        anchor.textContent = link.label;
                        li.appendChild(anchor);
                        linkListElement.appendChild(li);
                    });
                    linkListElement.classList.add('is-visible');
                    linkListElement.setAttribute('aria-hidden', 'false');
                    if (cardElement) {
                        cardElement.classList.add('is-hidden');
                    }
                };

                const restoreDefaults = () => {
                    const defaults = defaultProducts[index];
                    if (!defaults) {
                        return;
                    }
                    if (headingElement) {
                        if (defaults.heading) {
                            resetHeading(defaults.heading, false);
                        } else {
                            resetHeading('\u00A0', true);
                        }
                    }
                    if (titleElement) {
                        titleElement.textContent = defaults.title;
                    }
                    if (metaElement) {
                        metaElement.textContent = defaults.meta;
                    }
                    if (imageElement) {
                        imageElement.src = defaults.image.src;
                        imageElement.alt = defaults.image.alt;
                    }
                    showCard();
                };

                if (!overrides) {
                    restoreDefaults();
                    return;
                }

                if (index === 0 && overrides.first) {
                    resetHeading('From your history', false);
                    if (titleElement) {
                        titleElement.textContent = overrides.first.title;
                    }
                    if (metaElement) {
                        metaElement.textContent = overrides.first.meta;
                    }
                    if (imageElement && overrides.first.image) {
                        imageElement.src = overrides.first.image.src;
                        imageElement.alt = overrides.first.image.alt;
                    }
                    showCard();
                } else if (index === 1) {
                    resetHeading('\u00A0', true);
                    if (overrides.second) {
                        if (titleElement) {
                            titleElement.textContent = overrides.second.title;
                        }
                        if (metaElement) {
                            metaElement.textContent = overrides.second.meta;
                        }
                        if (imageElement && overrides.second.image) {
                            imageElement.src = overrides.second.image.src;
                            imageElement.alt = overrides.second.image.alt;
                        }
                    }
                    showCard();
                } else if (index === 2) {
                    const headingText = overrides.thirdHeading || '';
                    if (headingText) {
                        resetHeading(headingText, false);
                    } else {
                        resetHeading('\u00A0', true);
                    }
                    if (overrides.thirdLinks && overrides.thirdLinks.length > 0) {
                        showLinkList(overrides.thirdLinks);
                    } else {
                        restoreDefaults();
                    }
                } else if (index === 3) {
                    resetHeading('Trending', false);
                    showCard();
                } else {
                    restoreDefaults();
                }
            });
        };

        const buildSuggestionItem = (label, type = 'recent') => {
            const item = document.createElement('li');
            item.className = 'suggestion-item';

            const primary = document.createElement('span');
            primary.className = 'suggestion-primary';

            if (type === 'recent') {
                const icon = document.createElement('img');
                icon.src = 'icons/clock.svg';
                icon.alt = 'Recent search';
                icon.className = 'suggestion-icon';
                primary.appendChild(icon);
            } else {
                const icon = document.createElement('span');
                icon.className = 'suggestion-icon-search';
                primary.appendChild(icon);
            }

            primary.appendChild(document.createTextNode(label));
            item.appendChild(primary);

            return item;
        };

        const renderSuggestions = (query) => {
            if (!suggestionsListElement || !suggestionsHeadingElement) {
                return;
            }

            const normalizedQuery = query.trim();
            const lowerQuery = normalizedQuery.toLowerCase();
            suggestionsListElement.innerHTML = '';

            let suggestions = [];
            let isRecent = false;
            let presetKey = '';

            if (normalizedQuery === '') {
                // Empty query: show recent searches with clock icons
                isRecent = true;
                suggestions = recentSearches;
                presetKey = '';
            } else {
                // Has query: show filtered suggestions with magnifying glass icons
                isRecent = false;
                
                // Check for preset matches first (hoka, hok, ho)
                const presetOrder = ['hoka', 'hok', 'ho'];
                presetKey = presetOrder.find((key) => lowerQuery.startsWith(key)) || '';
                
                if (presetKey && suggestionPresets[presetKey]) {
                    suggestions = suggestionPresets[presetKey];
                } else {
                    // Filter all suggestions based on query
                    suggestions = allSuggestions.filter(suggestion => 
                        suggestion.toLowerCase().includes(lowerQuery)
                    ).slice(0, 6); // Limit to 6 suggestions
                    presetKey = normalizedQuery.toLowerCase();
                }
            }

            suggestionsHeadingElement.textContent = isRecent ? 'Recent Searches' : 'Suggestions';

            log('[Suggestions Render]', {
                query: normalizedQuery,
                lowerQuery: lowerQuery,
                presetKey: presetKey,
                suggestionCount: suggestions.length,
                isRecent: isRecent,
                heading: isRecent ? 'Recent Searches' : 'Suggestions'
            });

            suggestions.forEach((label) => {
                const item = buildSuggestionItem(label, isRecent ? 'recent' : 'generated');
                suggestionsListElement.appendChild(item);
            });

            const showProductPreview = lowerQuery === 'hoka';
            if (suggestionProductCard && suggestionsContentElement) {
                if (showProductPreview) {
                    suggestionProductCard.classList.add('is-visible');
                    suggestionProductCard.setAttribute('aria-hidden', 'false');
                    suggestionsContentElement.classList.add('has-product');
                } else {
                    suggestionProductCard.classList.remove('is-visible');
                    suggestionProductCard.setAttribute('aria-hidden', 'true');
                    suggestionsContentElement.classList.remove('has-product');
                }
            }

            try {
                applyProductOverrides(presetKey);
            } catch (error) {
                console.error('Error applying product overrides:', error);
            }
        };

        if (searchBox && searchBackground && viewport && searchWrapper && searchSuggestions && suggestionsHeadingElement && searchSuggestionsProducts && viewportOverlay) {
            // Search mode: active when the search overlay expands beyond its resting height.
            let collapsedSearchBackgroundHeight = searchBackground.offsetHeight;
            let isSearchMode = false;
            let borderColorTimeoutId = null;
            let currentBorderColor = window.getComputedStyle(searchBackground).borderBottomColor;
            let overlayPendingShow = false;
            let overlayShowTimeoutId = null;

            renderSuggestions('');

            const collapsedBackgroundColorTop = 'rgba(255, 255, 255, 0)';
            const collapsedBackgroundColorScrolled = 'rgba(255, 255, 255, 0.7)';
            const expandedBackgroundColor = 'rgba(255, 255, 255, 0.95)';
            const borderColorVisible = 'rgba(0, 0, 0, 0.1)';
            const borderColorHidden = 'rgba(0, 0, 0, 0)';

            const applyBorderColor = (color) => {
                if (borderColorTimeoutId) {
                    clearTimeout(borderColorTimeoutId);
                    borderColorTimeoutId = null;
                }
                currentBorderColor = color;
                searchBackground.style.borderBottomColor = color;
            };

            const scheduleBorderColor = (color, delayMs) => {
                if (color === currentBorderColor && borderColorTimeoutId === null) {
                    return;
                }

                if (delayMs <= 0) {
                    applyBorderColor(color);
                    return;
                }

                if (borderColorTimeoutId) {
                    clearTimeout(borderColorTimeoutId);
                }

                borderColorTimeoutId = window.setTimeout(() => {
                    applyBorderColor(color);
                }, delayMs);
            };

            const positionCloseButton = () => {
                if (!searchCloseButton) return;
                const backgroundRect = searchBackground.getBoundingClientRect();
                const searchBoxRect = searchBox.getBoundingClientRect();
                const buttonHeight = searchCloseButton.offsetHeight || 1;
                const offsetWithinBackground = (searchBoxRect.top - backgroundRect.top) + (searchBox.offsetHeight / 2) - (buttonHeight / 2);

                searchCloseButton.style.top = `${Math.max(offsetWithinBackground, 0)}px`;
            };

            const updateProductsPosition = () => {
                if (!isSearchMode || !searchSuggestions.classList.contains('is-visible')) {
                    searchSuggestionsProducts.style.marginTop = '';
                    searchSuggestionsProducts.style.maxHeight = '';
                    log('[Product Position] Hidden - marginTop and maxHeight cleared');
                    return;
                }

                // Force layout recalculation by reading layout properties
                void searchSuggestions.offsetHeight;
                void searchSuggestions.scrollHeight;
                void suggestionsListElement.offsetHeight;
                
                // Now get the actual height after forcing recalculation
                const suggestionsHeight = searchSuggestions.offsetHeight;
                const offset = suggestionsHeight + 24;
                const previousMarginTop = searchSuggestionsProducts.style.marginTop;
                searchSuggestionsProducts.style.marginTop = `${offset}px`;
                
                // Calculate available height for product cards to scroll
                const backgroundRect = searchBackground.getBoundingClientRect();
                const backgroundHeight = backgroundRect.height || searchBackground.offsetHeight;
                const bottomOverlayHeight = searchBackgroundBottomOverlay ? searchBackgroundBottomOverlay.offsetHeight : 50;
                const availableHeight = Math.max(backgroundHeight - offset - bottomOverlayHeight - 20, 200);
                searchSuggestionsProducts.style.maxHeight = `${availableHeight}px`;
                
                log('[Product Position]', {
                    suggestionsHeight: suggestionsHeight,
                    suggestionsScrollHeight: searchSuggestions.scrollHeight,
                    suggestionsListHeight: suggestionsListElement.offsetHeight,
                    calculatedOffset: offset,
                    backgroundHeight: backgroundHeight,
                    bottomOverlayHeight: bottomOverlayHeight,
                    availableHeight: availableHeight,
                    previousMarginTop: previousMarginTop,
                    newMarginTop: searchSuggestionsProducts.style.marginTop,
                    searchBoxValue: searchBox.value,
                    queryLength: searchBox.value.length
                });
            };

            const updateSearchBackgroundAppearance = () => {
                const shouldShowOverlay = isSearchMode || viewport.scrollTop > 0;

                if (shouldShowOverlay) {
                    const delayMs = !isSearchMode && viewport.scrollTop > 0 ? 120 : 0;
                    scheduleBorderColor(borderColorVisible, delayMs);
                } else {
                    scheduleBorderColor(borderColorHidden, 0);
                }

                if (isSearchMode) {
                    searchBackground.style.backgroundColor = expandedBackgroundColor;
                } else if (viewport.scrollTop > 0) {
                    searchBackground.style.backgroundColor = collapsedBackgroundColorScrolled;
                } else {
                    searchBackground.style.backgroundColor = collapsedBackgroundColorTop;
                }

                if (searchCloseButton) {
                searchCloseButton.classList.toggle('is-visible', isSearchMode);
                    searchCloseButton.setAttribute('aria-hidden', String(!isSearchMode));
                }

                searchSuggestions.classList.toggle('is-visible', isSearchMode);
                searchSuggestions.setAttribute('aria-hidden', String(!isSearchMode));

                searchSuggestionsProducts.classList.toggle('is-visible', isSearchMode);
                searchSuggestionsProducts.setAttribute('aria-hidden', String(!isSearchMode));

                if (searchBackgroundBottomOverlay) {
                    searchBackgroundBottomOverlay.classList.toggle('is-visible', isSearchMode);
                    searchBackgroundBottomOverlay.setAttribute('aria-hidden', String(!isSearchMode));
                }

                if (isSearchMode && !overlayPendingShow) {
                    viewportOverlay.classList.add('is-visible');
                } else if (!isSearchMode) {
                    viewportOverlay.classList.remove('is-visible');
                    overlayPendingShow = false;
                    if (overlayShowTimeoutId) {
                        clearTimeout(overlayShowTimeoutId);
                        overlayShowTimeoutId = null;
                    }
                }
                positionCloseButton();
                requestAnimationFrame(updateProductsPosition);
            };

            const refreshCollapsedHeight = () => {
                if (!isSearchMode) {
                    collapsedSearchBackgroundHeight = searchBackground.offsetHeight;
                }
            };

            const getBaseHeight = () => {
                if (browserWindow && browserWindow.offsetHeight) {
                    return browserWindow.offsetHeight;
                }

                if (viewport && viewport.clientHeight) {
                    return viewport.clientHeight;
                }

                return window.innerHeight || collapsedSearchBackgroundHeight;
            };

            const enterSearchMode = () => {
                if (isSearchMode) {
                    return;
                }

                refreshCollapsedHeight();
                isSearchMode = true;
                searchWrapper.style.width = '70%';
                searchBackground.style.height = `${collapsedSearchBackgroundHeight}px`;
                searchBackground.style.marginBottom = '0px';
                overlayPendingShow = true;
                viewportOverlay.classList.remove('is-visible');
                if (overlayShowTimeoutId) {
                    clearTimeout(overlayShowTimeoutId);
                }
                renderSuggestions(searchBox.value);
                updateSearchBackgroundAppearance();

                window.requestAnimationFrame(() => {
                    const targetHeight = Math.max(getBaseHeight() * 0.84, collapsedSearchBackgroundHeight);
                    const targetMarginBottom = collapsedSearchBackgroundHeight - targetHeight;

                    searchBackground.style.height = `${targetHeight}px`;
                    searchBackground.style.marginBottom = `${targetMarginBottom}px`;
                    updateSearchBackgroundAppearance();
                    positionCloseButton();
                    updateProductsPosition();

                    const handleExpandTransitionEnd = (event) => {
                        if (event.propertyName !== 'height') {
                            return;
                        }

                        searchBackground.removeEventListener('transitionend', handleExpandTransitionEnd);
                        if (overlayPendingShow && isSearchMode) {
                            overlayPendingShow = false;
                            if (overlayShowTimeoutId) {
                                clearTimeout(overlayShowTimeoutId);
                                overlayShowTimeoutId = null;
                            }
                            viewportOverlay.classList.add('is-visible');
                        }

                        requestAnimationFrame(() => {
                            positionCloseButton();
                            updateProductsPosition();
                        });
                    };

                    searchBackground.addEventListener('transitionend', handleExpandTransitionEnd, { once: true });

                    overlayShowTimeoutId = window.setTimeout(() => {
                        if (overlayPendingShow && isSearchMode) {
                            overlayPendingShow = false;
                            viewportOverlay.classList.add('is-visible');
                        }
                    }, 450);
                });
            };

            const exitSearchMode = () => {
                if (!isSearchMode) {
                    return;
                }

                const currentHeight = searchBackground.offsetHeight;
                isSearchMode = false;
                searchWrapper.style.width = '';
                updateSearchBackgroundAppearance();

                overlayPendingShow = false;
                viewportOverlay.classList.remove('is-visible');
                if (overlayShowTimeoutId) {
                    clearTimeout(overlayShowTimeoutId);
                    overlayShowTimeoutId = null;
                }
                renderSuggestions('');

                searchBackground.style.height = `${currentHeight}px`;

                window.requestAnimationFrame(() => {
                    searchBackground.style.height = `${collapsedSearchBackgroundHeight}px`;
                    searchBackground.style.marginBottom = '0px';
                    updateSearchBackgroundAppearance();
                    positionCloseButton();
                    updateProductsPosition();
                });

                const handleTransitionEnd = (event) => {
                    if (event.propertyName !== 'height') {
                        return;
                    }

                    searchBackground.style.height = '';
                    searchBackground.style.marginBottom = '';
                    searchBackground.removeEventListener('transitionend', handleTransitionEnd);
                    refreshCollapsedHeight();
                    updateSearchBackgroundAppearance();
                    positionCloseButton();
                    updateProductsPosition();
                };

                searchBackground.addEventListener('transitionend', handleTransitionEnd, { once: true });
            };

            searchBox.addEventListener('focus', enterSearchMode);
            
            let previousValue = '';
            let previousLength = 0;
            
            searchBox.addEventListener('input', (event) => {
                const currentValue = event.target.value;
                const currentLength = currentValue.length;
                const action = currentLength > previousLength ? 'ADDED' : currentLength < previousLength ? 'DELETED' : 'UNCHANGED';
                
                log('[Keystroke]', {
                    action: action,
                    previousValue: previousValue,
                    previousLength: previousLength,
                    currentValue: currentValue,
                    currentLength: currentLength,
                    characterChange: action === 'ADDED' ? currentValue[currentLength - 1] : action === 'DELETED' ? '←' : 'none'
                });
                
                // Capture the previous value BEFORE updating it (for transition detection)
                const savedPreviousValue = previousValue;
                
                previousValue = currentValue;
                previousLength = currentLength;
                
                renderSuggestions(currentValue);
                
                // Check if we're transitioning from product preview (hoka) to no preview (hok)
                // Use savedPreviousValue since previousValue has already been updated
                const hadProductPreview = savedPreviousValue.toLowerCase() === 'hoka';
                const hasProductPreview = currentValue.toLowerCase() === 'hoka';
                const isTransitioningAwayFromPreview = hadProductPreview && !hasProductPreview;
                
                // Use double requestAnimationFrame plus a timeout to ensure DOM updates and layout are complete
                // The timeout accounts for the flex-basis transition (0.3s) on the suggestions list
                // When transitioning away from product preview, wait longer for the layout to fully collapse
                const timeoutDelay = isTransitioningAwayFromPreview ? 350 : 10;
                
                log('[Position Update] Scheduling position update...', {
                    hadProductPreview: hadProductPreview,
                    hasProductPreview: hasProductPreview,
                    isTransitioningAwayFromPreview: isTransitioningAwayFromPreview,
                    timeoutDelay: timeoutDelay
                });
                
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            log('[Position Update] Executing position update');
                            updateProductsPosition();
                        }, timeoutDelay);
                    });
                });
            });
            if (searchCloseButton) {
            searchCloseButton.addEventListener('click', (event) => {
                event.preventDefault();
                exitSearchMode();
            });
            }

            if (searchBackgroundBottomOverlay) {
                searchBackgroundBottomOverlay.addEventListener('click', (event) => {
                    event.preventDefault();
                    exitSearchMode();
                });
            }

            document.addEventListener('mousedown', (event) => {
                if (!isSearchMode) {
                    return;
                }

                if (searchBackground.contains(event.target) || (searchCloseButton && searchCloseButton.contains(event.target))) {
                    return;
                }

                exitSearchMode();
            });

            viewport.addEventListener('scroll', updateSearchBackgroundAppearance);
            window.addEventListener('resize', refreshCollapsedHeight);
            window.addEventListener('resize', positionCloseButton);
            window.addEventListener('resize', () => requestAnimationFrame(updateProductsPosition));
            updateSearchBackgroundAppearance();
            positionCloseButton();
            updateProductsPosition();

            // Handle scrolling of product cards when mouse is over search background
            const handleBackgroundWheel = (event) => {
                log('[Wheel Event]', {
                    isSearchMode,
                    productCardsVisible: searchSuggestionsProducts ? searchSuggestionsProducts.classList.contains('is-visible') : false,
                    targetElement: event.target.className,
                    isInSearchBackground: searchBackground ? searchBackground.contains(event.target) : false
                });

                if (!isSearchMode || !searchSuggestionsProducts || !searchSuggestionsProducts.classList.contains('is-visible')) {
                    log('[Wheel Event] Early return - search mode, products, or visibility check failed');
                    return;
                }

                // Check if we're in the search background by checking position
                const bgRect = searchBackground.getBoundingClientRect();
                const eventX = event.clientX;
                const eventY = event.clientY;
                const isMouseInBackground = eventX >= bgRect.left && eventX <= bgRect.right && eventY >= bgRect.top && eventY <= bgRect.bottom;

                log('[Wheel Event] Mouse position check', {
                    eventX,
                    eventY,
                    bgRect: { left: bgRect.left, right: bgRect.right, top: bgRect.top, bottom: bgRect.bottom },
                    isMouseInBackground
                });

                if (!isMouseInBackground) {
                    log('[Wheel Event] Mouse not in background area');
                    return;
                }

                const maxScrollTop = searchSuggestionsProducts.scrollHeight - searchSuggestionsProducts.clientHeight;
                log('[Wheel Event] Scroll metrics', {
                    scrollHeight: searchSuggestionsProducts.scrollHeight,
                    clientHeight: searchSuggestionsProducts.clientHeight,
                    maxScrollTop
                });

                if (maxScrollTop <= 0) {
                    log('[Wheel Event] No scrollable content');
                    return;
                }

                const currentScrollTop = searchSuggestionsProducts.scrollTop;
                const speedMultiplier = event.deltaMode === 1 ? 120 : 6;
                const deltaY = event.deltaY * speedMultiplier;
                const atTop = currentScrollTop <= 0;
                const atBottom = currentScrollTop >= maxScrollTop;

                log('[Wheel Event] Scroll attempt', {
                    currentScrollTop,
                    rawDelta: event.deltaY,
                    speedMultiplier,
                    deltaY,
                    atTop,
                    atBottom
                });

                // Allow scrolling through suggestions panel when at edges
                if ((deltaY < 0 && atTop) || (deltaY > 0 && atBottom)) {
                    log('[Wheel Event] At edge, allowing default scroll');
                    return;
                }

                event.preventDefault();
                const nextScrollTop = Math.min(Math.max(currentScrollTop + deltaY, 0), maxScrollTop);
                searchSuggestionsProducts.scrollTop = nextScrollTop;
                log('[Wheel Event] Scrolled to', nextScrollTop);
            };

            searchBackground.addEventListener('wheel', handleBackgroundWheel, { passive: false });
        }
    </script>
</body>
</html>
